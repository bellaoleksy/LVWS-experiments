---
title: "Incubation Experiment Results"
author: "Bella Oleksy"
date: "5/22/2018"
output: html_document
---

```{r markdown document set up, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_chunk$set(fig.width=8, fig.height=7) 
knitr::opts_chunk$set(error = TRUE)
```


# Sky Pond Incubation Experiment (at USGS Fort)


```{r load data and manipulate data frame, warning=FALSE, message=FALSE, echo=FALSE, tidy=TRUE, include=FALSE}
#Load appropriate libraries

library(dplyr)
library(ggplot2)
# if(!require(devtools)) install.packages("devtools")
# devtools::install_github("kassambara/ggpubr")
library(ggpubr)
library(ggthemes)
library(knitr) # to print table in R markdown
library(kableExtra) # for making tables pretty/legible
library(data.table)
library(car) #for Anova not anova bc of unbalanced data
library(EnvStats) # for stat_n_text()

expchem <- read.csv("data_clean/waterchem_warmingxnutrient_171206.csv")
#Added an "initial_NO3_mgL" column on 2018-02-15
#from "2017_OleksyNutrientGrowthExperiment_WaterChemistry.xlsx"

expchem$temperature <- as.factor(expchem$temperature)
expchem <- as.tbl(expchem)
glimpse(expchem)

expchem <- expchem %>%
  mutate(NH4_uM = (NH4_mgL * 1000) / 18.038508,
         initial_NH4_uM = (initial_NH4_mgL * 1000) / 18.038508,
         changeNH4_uM = initial_NH4_uM - NH4_uM,
         changeDOC_mgL=DOC_mgL-initial_DOC_mgL,
         changeTDN_uM=initial_TDN_uM-TDN_uM,
         changePO4_uM=initial_PO4_uM-PO4_uM,
         changeNH4_mgL=initial_NH4_mgL-NH4_mgL,
         changeNO3_mgL=initial_NO3_mgL-NO3_mgL,
         percNO3uptake = (initial_NO3_mgL-NO3_mgL)/initial_NO3_mgL * 100,
         percTDNuptake = (initial_TDN_uM-TDN_uM)/initial_TDN_uM * 100,
         percPO4uptake = (initial_PO4_uM-PO4_uM)/initial_PO4_uM * 100,
         TDNuptake_dailyrate = changeTDN_uM/8,
         NO3uptake_dailyrate = changeNO3_mgL/8)
  
expchem_trim <- expchem %>%
  select(sample_id, temperature, treatment, tempxtrt, rep, chl_a_phyto,changeDOC_mgL, changePO4_uM, changeTDN_uM, changePO4_uM, changeNH4_mgL, percTDNuptake, percPO4uptake,TDNuptake_dailyrate,NO3uptake_dailyrate,DOC_mgL, NH4_mgL, changeNO3_mgL, percNO3uptake, NH4_uM, changeNH4_uM)

expchem_changesummary <- expchem %>%
  group_by(tempxtrt, treatment, temperature) %>%
  summarize(meanchangeDOC_mgL=mean(changeDOC_mgL),
            sdchangeDOC_mgL=sd(changeDOC_mgL),
            meanchangeTDN_uM=mean(changeTDN_uM),
            sdchangeTDN_uM=sd(changeTDN_uM),
            meanchangeNO3_mgL=mean(changeNO3_mgL),
            sdchangeNO3_mgL=sd(changeNO3_mgL),
            meanchangePO4_uM=mean(changePO4_uM),
            sdchangePO4_uM=sd(changePO4_uM),
            meanchangeNH4_mgL=mean(changeNH4_mgL),
            sdchangeNH4_mgL=sd(changeNH4_mgL),
            meanchangeNH4_uM=mean(changeNH4_uM),
            sdchangeNH4_uM=sd(changeNH4_uM),
            meanphytochla=mean(chl_a_phyto),
            sdphytochla=sd(chl_a_phyto),
            meanpercTDNuptake=mean(percTDNuptake),
            sdpercTDNuptake=sd(percTDNuptake),
            meanpercNO3uptake=mean(percNO3uptake),
            sdpercNO3uptake=sd(percNO3uptake),
            meanTDNuptake_dailyrate=mean(TDNuptake_dailyrate),
            sdTDNuptake_dailyrate=sd(TDNuptake_dailyrate),
            meanNO3uptake_dailyrate=mean(NO3uptake_dailyrate),
            sdNO3uptake_dailyrate=sd(NO3uptake_dailyrate),            
            n= n()) %>%
  arrange(temperature)
expchem_changesummary

#Specify temperature as factor
expchem_changesummary$temperature <- as.factor(expchem_changesummary$temperature)
expchem_trim$temperature <- as.factor(expchem_trim$temperature)

#Order the factors for graphing
expchem_changesummary$treatment <- factor(expchem_changesummary$treatment, levels=c('C','N','P',
                                               'NP'))
expchem_trim$treatment <- factor(expchem_trim$treatment, levels=c('C','N','P',
                                               'NP'))

trtcolors <- c("#40A339", "#3166A9", "#DE0019", "#82388E") #treatment colors
tempcolors <- c( "#3166A9", "#40A339","#DE0019") #treatment colors
```


## Nutrient Uptake/Release Data 

### Data Visualization - TDN uptake

Before we jump into any statistical analyses, just want to get an idea of how things play out by treatment and temperature .

#### TDN uptake rates and % assimilated - Data table summary
```{r data table summary all treatments and nutrients TDN, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}

expchem_changesummary %>%
  select(treatment, temperature, meanchangeTDN_uM,sdchangeTDN_uM, n) %>%
  kable("html", digits=3, caption="Incubation experiment nutrient data summary: means, standard deviation, and number of replicates per treatment") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = F, position="left", font_size=12)
```

####TDN uptake rates and % assimilated - Descriptive statistics and plots
Here we have some summary statistics for TDN uptake. First we are looking at change in TDN from start to end of experiment by TEMPERTURE and by TREATMENT separately. I've also plotted boxplots with individual points. 
```{r histograms of each group TDN, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
library(DescTools)

Desc(changeTDN_uM ~ temperature, data=expchem_trim, digits=1, plotit=TRUE)
Desc(changeTDN_uM ~ treatment, data=expchem_trim, digits=1, plotit=TRUE)

# library(lattice)
# 
# histogram(~ changeTDN_uM | temperature, 
#           data=expchem_trim,
#           layout=c(1,3),
#           col="#3166A9",
#           main="Change in TDN by Temperature")
# histogram(~ changeTDN_uM | treatment, 
#           data=expchem_trim,
#           layout=c(1,4),
#           col="#3166A9",
#           main="Change in TDN by Nutrient Treatment")

boxplot(changeTDN_uM ~ temperature * treatment, data=expchem_trim)
# ggsave("boxplot.png")

```

```{r TDN data visualization}

ggplot(expchem_changesummary, aes(x=treatment, y=meanTDNuptake_dailyrate, fill=treatment)) + theme_bw()+
   geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\namendment",
                    labels=c("Control", "Nitrogen", "Phosphorus", "Both (N & P)"))+
  geom_errorbar(aes(ymin=meanTDNuptake_dailyrate-sdTDNuptake_dailyrate, ymax=meanTDNuptake_dailyrate+sdTDNuptake_dailyrate),
                width=.2,
                position=position_dodge(0.9))+
  coord_cartesian(ylim=c(0,8))+
  scale_y_continuous(breaks=seq(0,8,1))+
    facet_wrap( ~ temperature , ncol=3, scales="free")+
  # geom_hline(yintercept=66) +
  # annotate("text",1,66,vjust=-1,label="  Starting [TDN] in N & N+P treatments")+
  # geom_hline(yintercept=18, color="black", linetype="dashed")+
  # annotate("text",0.8,18,vjust=-1,label="Background [TDN]")+
  labs(x="",y=" [uM N/day]", title="Dissolved inorganic N uptake rate")

# ggsave("TDN_uptakerate.png", width=16, height=9.5,units="in")

# TDM uptake boxplot

# ggplot(expchem_trim, aes(x=temperature, y=TDNuptake_dailyrate, fill=treatment)) +
#   geom_boxplot()+
#   stat_boxplot(geom ='errorbar') +
#   scale_fill_manual(values=trtcolors,
#                     name="Nutrient\nTreatment",
#                     labels=c("Control", "Nitrogen", "Phosphorus", "N&P"))+
#   coord_cartesian(ylim=c(0,8))+
#   scale_y_continuous(breaks=seq(0, 8, 1))+
#   labs(x="Incubation temperature",y="[uM/day]", title="Dissolved inorganic N uptake rate")

# ggsave("TDN_uptakerate_boxplot.png", width=16, height=9.5,units="in")



#BOXPLOT What percentage of N was taken up
# ggplot(expchem_trim, aes(x=treatment, y=percTDNuptake, color=treatment)) +
#      geom_boxplot(position=position_dodge(0.8))+
#     geom_jitter(position=position_jitter(0.2))+
#   scale_color_manual(values=trtcolors)+
#   theme_bw()+
#   facet_wrap( ~ temperature, ncol=3, scales="free")+
#   labs(x="Nutrient Treatment",y="Percent of Initial TDN assimilated")

#Bar plot of % N taken up

ggplot(expchem_changesummary, aes(x=treatment, y=meanpercTDNuptake, fill=treatment)) + theme_bw()+
   geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\nTreatment\n",
                    labels=c("Control\n", "Nitrogen\n", "Phosphorus\n", "Both (N & P)\n"))+
  geom_errorbar(aes(ymin=meanpercTDNuptake-sdpercTDNuptake, ymax=meanpercTDNuptake+sdpercTDNuptake),
                width=.2,
                position=position_dodge(0.9))+
  coord_cartesian(ylim=c(0,100))+
  scale_y_continuous(breaks=seq(0,100,10))+
    facet_wrap( ~ temperature, ncol=3, scales="free")+
  # geom_hline(yintercept=66) +
  # annotate("text",1,66,vjust=-1,label="  Starting [TDN] in N & N+P treatments")+
  # geom_hline(yintercept=18, color="black", linetype="dashed")+
  # annotate("text",0.8,18,vjust=-1,label="Background [TDN]")+
  labs(x="Temperature Treatment",y="% Assimilated", title="Percentage of nitrogen assimilated from experimental starting conditions")

# ggsave("percNuptake.png", width=20, height=12,units="in")


```


#### TDN uptake rates - ANOVA results - with intxn
From our preliminary glance at the data, it appears there is an interaction between the temperature of the experiment and the nutrient treatment. In the N-only treatment,
TDN uptake increased with temperature. Interesting, in the N+P nutrient treatment, almost all of the TDN was consumed in the experiment. The following two plots are interaction plots of by nutrient treatment and temperature treatment, respecitvely.

**Change in TDN - N uptake rates** 
```{r TDN ANOVA Type II, echo=FALSE, tidy=TRUE}
TDN_Model1 <- lm(changeTDN_uM ~  temperature * treatment, data=expchem_trim)
library(emmeans) #Estimated Marginal Means
emmip(TDN_Model1, temperature ~ treatment)
emmip(TDN_Model1, treatment~temperature)
Anova(TDN_Model1, type=3, contrasts=c("constr.sum","contr.poly")) 

#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 

```

> Studying the output of the ANOVA table (Type III SS), we see there is a evidence of a significant interaction effect (F=46.453, p<0.0001). The test for the main effect of nutrient treatment is significant (p<0.0001) but the test for the main effect of temperature alone is not significant (p=0.13).  After fitting an ANOVA model it is important to always check the relevant model assumptions.  This includes making QQ-plots and residual plots. Will use Levene's test of equality of variances too. 

```{r TDN qqplots and residuals, echo=FALSE, tidy=TRUE}
TDNresults <- lm(changeTDN_uM ~ treatment * temperature, data=expchem_trim)
summary(TDNresults)
qqnorm(TDNresults$res)
plot(TDNresults$fitted,TDNresults$res,xlab="Fitted",ylab="Residuals")
leveneTest(changeTDN_uM ~ treatment * temperature,data=expchem_trim)


```

> Neither plot indicates a significant violation of normality assumptions. We're good here.

####TDN uptake rates - Pairwise comparisons

Pairwise comparsions for each level of temperature
```{r TDN pairwise trt x temp , echo=FALSE, tidy=TRUE}
library(emmeans) #Estimated Marginal Means
emms_TDN_trtxtemp <- emmeans(TDN_Model1, pairwise ~ treatment | temperature)
#Pairwise comparsions for each level of temperature
emms_TDN_trtxtemp
```

Pairwise comparsions for each level of nutrient treatment
```{r TDN pairwise temp x trt, echo=FALSE, tidy=TRUE}
emms_TDN_tempxtrt <- emmeans(TDN_Model1, pairwise ~ temperature | treatment)
#Pairwise comparsions for each level of nutrient treatment
emms_TDN_tempxtrt
```

#### TDN % assimilated - ANOVA results - with intxn
**Percent N uptake**
```{r, echo=FALSE, tidy=TRUE, tidy=TRUE}
#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 
TDN_uptake_Model1 <- lm(percTDNuptake ~ temperature * treatment, data=expchem_trim)
emmip(TDN_uptake_Model1, temperature ~ treatment)
emmip(TDN_uptake_Model1, treatment~temperature)
Anova(TDN_uptake_Model1, type=3, contrasts=c("constr.sum","contr.poly")) 
```

> In contrast to the previous model, if we look at %N assimilated, there is a siginificant effect of temperature and nutrients as well as an interaction between temperature and nutrients. 

```{r, echo=FALSE, tidy=TRUE, tidy=TRUE}

summary(TDN_uptake_Model1)
qqnorm(TDN_uptake_Model1$res)
plot(TDN_uptake_Model1$fitted,TDN_uptake_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(percTDNuptake ~ treatment * temperature,data=expchem_trim)

```

> Percent N uptake model meets the assumptions of normality, too.

####TDN % assimilated - Pairwise comparisons

Pairwise comparsions for each level of temperature
```{r, echo=FALSE, tidy=TRUE}
library(emmeans) #Estimated Marginal Means
emms_TDN_trtxtemp <- emmeans(TDN_uptake_Model1, pairwise ~ treatment | temperature)
#Pairwise comparsions for each level of temperature
emms_TDN_trtxtemp
```

> At 8 degrees, all nutrient treatments are significantly different from each other. At 12 degrees, all nutrients treatments are significantly different from each other except C vs P. At 16 degrees, all nutrients treatments are significantly different from each other except C vs P.

Pairwise comparsions for each level of nutrient treatment
```{r, echo=FALSE, tidy=TRUE}
emms_TDN_tempxtrt <- emmeans(TDN_uptake_Model1, pairwise ~ temperature | treatment)
#Pairwise comparsions for each level of nutrient treatment
emms_TDN_tempxtrt
```

> In the control, there is a different between 8 vs 12 and 12 vs 16, but not 8 vs 16. In the N treatment, there is a difference between 8 vs. 16 and 12 vs. 16, but not 8 vs. 12.
In the P treatment, there are no differences across temperatures. In the NP treatment, there is only a significant difference between 8 vs 12. 8 vs 16 is marginally significant (p=0.07)

### Data Visualization - NO3 uptake

Before we jump into any statistical analyses, just want to get an idea of how things play out by treatment and temperature .

#### NO3 uptake - Data table summary
```{r data table summary all treatments and nutrients NO3, echo=FALSE, message=FALSE, warning=FALSE, tidy=TRUE}

expchem_changesummary %>%
  select(treatment, temperature, meanchangeNO3_mgL,sdchangeNO3_mgL, n) %>%
  kable("html", digits=3, caption="Incubation experiment nutrient data summary: means, standard deviation, and number of replicates per treatment") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = F, position="left", font_size=12)
```

####NO3 uptake - Descriptive statistics and plots
Here we have some summary statistics for NO3 uptake. First we are looking at change in NO3 from start to end of experiment by TEMPERTURE and by TREATMENT separately. I've also plotted boxplots with individual points. 
```{r histograms of each group NO3, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
library(DescTools)

Desc(changeNO3_mgL ~ temperature, data=expchem_trim, digits=1, plotit=TRUE)
Desc(changeNO3_mgL ~ treatment, data=expchem_trim, digits=1, plotit=TRUE)

boxplot(changeNO3_mgL ~ temperature * treatment, data=expchem_trim)

```
> Similar results to change in TDN



```{r NO3 data visualization}

#BAR PLOT - Change in NO3
ggplot(expchem_changesummary, aes(x=treatment, y=meanchangeNO3_mgL, fill=treatment)) + theme_bw()+
   geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\namendment",
                    labels=c("Control", "Nitrogen", "Phosphorus", "Both (N & P)"))+
  geom_errorbar(aes(ymin=meanchangeNO3_mgL-sdchangeNO3_mgL, ymax=meanchangeNO3_mgL+sdchangeNO3_mgL),
                width=.2,
                position=position_dodge(0.9))+
  # coord_cartesian(ylim=c(0,0.5))+
  # scale_y_continuous(breaks=seq(0,0.5,0.1))+
  facet_wrap( ~ temperature , ncol=3, scales="free_y")+
  labs(x="",y="", title="Change in NO3\n(initial - final concentration [mg/L])")+
    theme(legend.position="bottom",
      axis.text.x=element_blank())

# ##BOX PLOT - Change in NO3
# ggplot(expchem_trim, aes(x=temperature, y=changeNO3_mgL, color=treatment)) +
#   geom_boxplot(position=position_dodge(0.8))+
#   geom_jitter(position=position_jitter(0.2))+
#       stat_n_text(size = 3) + 
#   labs(x="Temperature Treatment",y="Change in NO3\n(initial - final concentration [mg/L])")+
#   scale_color_manual(values=trtcolors)+
#   facet_wrap(~treatment)+
#   theme_bw(base_size=16)

#BAR PLOT - Daily nitrate uptake rate
ggplot(expchem_changesummary, aes(x=treatment, y=meanNO3uptake_dailyrate, fill=treatment)) + theme_bw()+
  geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\namendment",
                    labels=c("Control", "Nitrogen", "Phosphorus", "Both (N & P)"))+
  geom_errorbar(aes(ymin=meanNO3uptake_dailyrate-sdNO3uptake_dailyrate, ymax=meanNO3uptake_dailyrate+sdNO3uptake_dailyrate),
                width=.2,
                position=position_dodge(0.9))+
  coord_cartesian(ylim=c(0,0.5))+
  scale_y_continuous(breaks=seq(0,0.5,0.1))+
  facet_wrap( ~ temperature , ncol=3, scales="free_y")+
  labs(x="",y=" [mg NO3/day]", title="Daily nitrate uptake rate")+
    theme(legend.position="bottom",
      axis.text.x=element_blank())

##BOX PLOT - Daily nitrate uptake rate 

# ggplot(expchem_trim, aes(x=treatment, y=NO3uptake_dailyrate, fill=treatment)) +
#   geom_boxplot()+
#   stat_boxplot(geom ='errorbar') +
# 
#   scale_fill_manual(values=trtcolors,
#                     name="Nutrient\nTreatment",
#                     labels=c("Control", "Nitrogen", "Phosphorus", "N&P"))+
#   coord_cartesian(ylim=c(0,0.5))+
#   scale_y_continuous(breaks=seq(0,0.5,0.1))+
#   labs(x="Incubation temperature",y="[uM/day]", title="Dissolved inorganic N uptake rate")+
#     facet_wrap( ~ temperature , ncol=3, scales="free_y")+
#     theme_bw(base_size=16)

# ggsave("NO3_uptakerate_boxplot.png", width=16, height=9.5,units="in")



# #BOX PLOT - What percentage of N was taken up
# ggplot(expchem_trim, aes(x=treatment, y=percNO3uptake, color=treatment)) +
#      geom_boxplot(position=position_dodge(0.8))+
#     geom_jitter(position=position_jitter(0.2))+
#   scale_color_manual(values=trtcolors)+
#   coord_cartesian(ylim=c(0,100))+
#   scale_y_continuous(breaks=seq(0,100,10))+
#   facet_wrap( ~ temperature, ncol=3)+
#   labs(x="Nutrient Treatment",y="", title="Percent of Initial NO3 assimilated")+
#   theme_bw(base_size=16)


#BAR PLOT - What % NO3 taken up

ggplot(expchem_changesummary, aes(x=treatment, y=meanpercNO3uptake, fill=treatment)) +
   geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\nTreatment\n",
                    labels=c("Control\n", "Nitrogen\n", "Phosphorus\n", "Both (N & P)\n"))+
  geom_errorbar(aes(ymin=meanpercNO3uptake-sdpercNO3uptake, ymax=meanpercNO3uptake+sdpercNO3uptake),
                width=.2,
                position=position_dodge(0.9))+
  coord_cartesian(ylim=c(0,100))+
  scale_y_continuous(breaks=seq(0,100,10))+
  facet_wrap( ~ temperature, ncol=3, scales="free")+
  labs(x="Temperature Treatment",y="% Assimilated", title="Percentage of nitrate assimilated")+
  theme_bw()+
    theme(legend.position="bottom",
      axis.text.x=element_blank())


```

> This is actually really interesting to me. It seems that when the "system" is satured with N, there is an interaction with temperature: the higher the temperature, the more N is assimilated. However, when you add P along, N&P together, and no nutrients, almost all of the N is taken up. 

```{r}
#TO DO: worth doing some sort of analysis where we look how starting N:P ratio influences nitrate assimilation!!!
```


#### NO3 uptake - ANOVA results - with intxn

**Change in NO3**
```{r NO3 ANOVA Type II, echo=FALSE, tidy=TRUE}
NO3_Model1 <- lm(changeNO3_mgL ~  temperature * treatment -1, data=expchem_trim)
library(emmeans) #Estimated Marginal Means
emmip(NO3_Model1, temperature ~ treatment)
emmip(NO3_Model1, treatment~temperature)
Anova(NO3_Model1, type=3, contrasts=c("constr.sum","contr.poly")) 

#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 
```
> There is a significant effect of treatment on the change in NO3, and an interaction with temperature, but no effect of temperature alone. Same result we saw when we looked at TDN uptake takes or change in TDN from initial to end.

```{r, echo=FALSE, tidy=TRUE}
NO3results <- lm(changeNO3_mgL ~ treatment * temperature  -1 , data=expchem_trim)
summary(NO3results)
qqnorm(NO3results$res)
plot(NO3results$fitted,NO3results$res,xlab="Fitted",ylab="Residuals")
leveneTest(changeNO3_mgL ~ treatment * temperature,data=expchem_trim)
```

>After fitting an ANOVA model it is important to always check the relevant model assumptions.  This includes making QQ-plots and residual plots. Will use Levene's test of equality of variances too.  Doesn't meet the asummptions of normality. Humph. 

**Percent NO3 uptake**
```{r}
NO3_uptake_Model1 <- lm(percNO3uptake ~ temperature * treatment -1, data=expchem_trim)
emmip(NO3_uptake_Model1, temperature ~ treatment)
emmip(NO3_uptake_Model1, treatment~temperature)
Anova(NO3_uptake_Model1, type=3, contrasts=c("constr.sum","contr.poly")) 

```

>Studying the output of the ANOVA table (Type III SS), we see there is a evidence of a significant interaction effect (F=7.6899, p<0.0001). The test for the main effect of nutrient treatment is significant (F(3,59)=48.7603, p<0.0001) as is the main effect of temperature (F(2,59)=6.8206, p<0.001).  Pretty much same result we found when we looked at TDN % assimilated.

```{r NO3 qqplots and residuals, echo=FALSE, tidy=TRUE}

summary(NO3_uptake_Model1)
qqnorm(NO3_uptake_Model1$res)
plot(NO3_uptake_Model1$fitted,NO3_uptake_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(percNO3uptake ~ treatment * temperature,data=expchem_trim)
```
> Also doesn't really fit model assupmtions. However, I believe the TDN % assimilated model did, so might just want to present that instead. 


####NO3 uptake - Pairwise comparisons

Pairwise comparsions for each level of temperature
```{r NO3 pairwise trt x temp , echo=FALSE, tidy=TRUE}
library(emmeans) #Estimated Marginal Means
emms_NO3_trtxtemp <- emmeans(NO3_Model1, pairwise ~ treatment | temperature)
#Pairwise comparsions for each level of temperature
emms_NO3_trtxtemp


```

> At 8 degrees, all pairwise comparisons are significantly different except C vs P. At 12 degrees, all pairwise comparisons are significantly different except C vs P. At 16 degrees, all pairwise comparisons are significantly different except C vs P. 

Pairwise comparsions for each level of nutrient treatment
```{r NO3 pairwise temp x trt, echo=FALSE, tidy=TRUE}
emms_NO3_tempxtrt <- emmeans(NO3_Model1, pairwise ~ temperature | treatment)
#Pairwise comparsions for each level of nutrient treatment
emms_NO3_tempxtrt
```

> No differences amongst temperature treatments in the control. For the N treatment, all temperature comparisons are significantly different. No differences by temperature for P. For NP, 8 vs 12 and 8 vs 16 are significantly different, but not 12 vs 16. 

###Data Visualization - NH4

####NH4 release - Descriptive statistics and plots
Here we have some summary statistics for NH4 at end of the experiment.  
```{r histograms of each group NH4, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
library(DescTools)

Desc(NH4_uM ~ temperature, data=expchem, digits=1, plotit=TRUE)
Desc(NH4_uM ~ treatment, data=expchem, digits=1, plotit=TRUE)

# library(lattice)
# 
# histogram(~ NH4_uM | temperature, 
#           data=expchem,
#           layout=c(1,3),
#           col="#3166A9",
#           main="NH4 at end of experiment by Temperature")
# histogram(~ NH4_uM | treatment, 
#           data=expchem,
#           layout=c(1,4),
#           col="#3166A9",
#           main="NH4 at end of experiment by Nutrient Treatment")

boxplot(NH4_uM ~ temperature * treatment, data=expchem)
# ggsave("boxplot.png")

```

> Hmmm what's going on here? Lots of NH4 in the high N treatments but only at 8 and 12 degrees. Across all nutrient treatments, 16 degrees has the lowest NH4 concentrations at the end of the experiment. 

```{r NH4 data visualization, echo=FALSE, tidy=TRUE}

ggplot(expchem_changesummary, aes(x=treatment, y=meanchangeNH4_uM, fill=treatment)) + theme_bw()+
  geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\namendment",
                    labels=c("Control", "Nitrogen", "Phosphorus", "Both (N & P)"))+
  geom_errorbar(aes(ymin=meanchangeNH4_uM-sdchangeNH4_uM, ymax=meanchangeNH4_uM+sdchangeNH4_uM),
                width=.2,
                position=position_dodge(0.9))+
  # coord_cartesian(ylim=c(0,0.5))+
  # scale_y_continuous(breaks=seq(0,0.5,0.1))+
  facet_wrap( ~ temperature , ncol=3, scales="free_y")+
  labs(x="",y="", title="Change in NH4\n(initial - final concentration [uM])")+
    theme(legend.position="bottom",
      axis.text.x=element_blank())

ggplot(expchem_changesummary, aes(x=temperature, y=meanchangeNH4_uM, fill=temperature)) + theme_bw()+
  geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=tempcolors,
                    name="Nutrient\namendment",
                    labels=c("Control", "Nitrogen", "Phosphorus", "Both (N & P)"))+
  geom_errorbar(aes(ymin=meanchangeNH4_uM-sdchangeNH4_uM, ymax=meanchangeNH4_uM+sdchangeNH4_uM),
                width=.2,
                position=position_dodge(0.9))+
  # coord_cartesian(ylim=c(0,0.5))+
  # scale_y_continuous(breaks=seq(0,0.5,0.1))+
  facet_wrap( ~ treatment , ncol=2)+
  labs(x="",y="", title="Change in NH4\n(initial - final concentration [uM])")+
    theme(legend.position="bottom",
      axis.text.x=element_blank())
```

> Huh. So if you look at change in NH4, it's a slightly different picture. All treatments started with the same initial concentration. In all of the N treatments, there was net release. In the NP at 16 degrees, there was release. Ammonification/mineralization of organic matter??


```{r, echo=FALSE, tidy=TRUE}
# BOX PLOT - by temperature treatment
ggplot(expchem, aes(x=temperature, y=NH4_uM, color=treatment)) +
   geom_boxplot(position=position_dodge(0.8))+
  labs(x="Temperature Treatment",y="Ammonia conc. at end (mg/L)")+
  scale_color_manual(values=trtcolors)+
  theme_bw(base_size=16)
# ggsave("NH4_end_bytemp.png", width=10, height=6,units="in")

#BOX PLOT - BY nutrient treatment
ggplot(expchem, aes(x=treatment, y=NH4_uM, color=temperature)) +
   geom_boxplot(position=position_dodge(0.8))+
  labs(x="Temperature Treatment",y="Ammonia conc. at end (mg/L)")+
  theme_bw(base_size=16)
# ggsave("NH4_end_bytrt.png", width=10, height=6,units="in")


```


#### NH4 / Ammonification? - ANOVA results - with intxn

```{r NH4 ANOVA Type II, echo=FALSE, tidy=TRUE}
NH4_Model1 <- lm(NH4_uM ~  temperature * treatment -1 , data=expchem) #No intercept model 
library(emmeans) #Estimated Marginal Means
emmip(NH4_Model1, temperature ~ treatment)
emmip(NH4_Model1, treatment~temperature)
Anova(NH4_Model1, type=3, contrasts=c("constr.sum","contr.poly")) 

#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 

```

> There is an effect of temperature alone and there is an effect of nutrient treatment alone and an interaction between temp*nutrients.


```{r NH4 qqplots and residuals, echo=FALSE, tidy=TRUE}
summary(NH4_Model1)
qqnorm(NH4_Model1$res)
plot(NH4_Model1$fitted,NH4_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(NH4_uM ~ treatment * temperature -1,data=expchem)

```

> We don't exactly meet the assumptions of normality. 

**Try a log-transformation**
```{r NH4 model log transformed, echo=FALSE, tidy=TRUE}

NH4_Model2 <-lm(log(NH4_uM) ~  treatment  * temperature -1 , data=expchem) #No intercept model 
summary(NH4_Model2)
emmip(NH4_Model2, temperature ~ treatment)
emmip(NH4_Model2, treatment~temperature)
Anova(NH4_Model2, type=3, contrasts=c("constr.sum","contr.poly"))
```

> No effect of temperature alone. Effect of nutrients alone and a tempxnutrient interaction.

```{r, echo=FALSE, tidy=TRUE}
#Test for assumptions or normality
summary(NH4_Model2)
qqnorm(NH4_Model2$res)
plot(NH4_Model2$fitted,NH4_Model2$res,xlab="Fitted",ylab="Residuals")
leveneTest(log(NH4_uM) ~ treatment * temperature,data=expchem)
```

> Log transformation helps

####NH4 / Ammonification? - Pairwise comparisons

Pairwise comparsions for each level of temperature
```{r NH4 pairwise trt x temp , echo=FALSE, tidy= TRUE}
library(emmeans) #Estimated Marginal Means
emms_NH4_trtxtemp <- emmeans(NH4_Model2, pairwise ~ treatment | temperature)
#Pairwise comparsions for each level of temperature
emms_NH4_trtxtemp
```

> At 8 degrees, C vs N, N vs NP, and N vs P are different. At 12 degrees, (same result) C vs N, N vs NP, and N vs P are different. No differences at 16 degrees. 

Pairwise comparsions for each level of nutrient treatment
```{r NH4 pairwise temp x trt, echo=FALSE, tidy=TRUE}
emms_NH4_tempxtrt <- emmeans(NH4_Model2, pairwise ~ temperature | treatment)
#Pairwise comparsions for each level of nutrient treatment
emms_NH4_tempxtrt

```

> No differences between controls across temperatures. Differences bteween 8 vs 16 and 12 vs 16 in the nitrogen treamtents. No differences across temperature in the NP treatment. No differences between P treatments across temperatures.


### Data Visualization - DOC exudation

Before we jump into any statistical analyses, just want to get an idea of how things play out by treatment and temperature .

#### DOC exudation - Data table summary
```{r data table summary all treatments and nutrients DOC, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}

expchem_changesummary %>%
  select(treatment, temperature, meanchangeDOC_mgL, sdchangeDOC_mgL, n) %>%
  kable("html", digits=3, caption="Incubation experiment nutrient data summary: means, standard deviation, and number of replicates per treatment") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = F, position="left", font_size=12)
```

####DOC exudation - Descriptive statistics and plots
Here we have some summary statistics for DOC exudation. First we are looking at change in DOC from start to end of experiment by TEMPERTURE and by TREATMENT separately. I've also plotted boxplots with individual points. Due to the way I calculated these values (final minus initial), bigger numbers here mean there is MORE dissolved organic carbon at the end of the experiment than the begining. All experimental units had more DOC at the end than the beginning, but the magnitude varied by temperature x nutrient combo.

```{r histograms of each group DOC, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
library(DescTools)
Desc(changeDOC_mgL ~ temperature, data=expchem_trim, digits=1, plotit=TRUE)
Desc(changeDOC_mgL ~ treatment, data=expchem_trim, digits=1, plotit=TRUE)

# library(lattice)
# 
# histogram(~ changeDOC_mgL | temperature, 
#           data=expchem_trim,
#           layout=c(1,3),
#           col="#3166A9",
#           main="Change in DOC by Temperature")
# histogram(~ changeDOC_mgL | treatment, 
#           data=expchem_trim,
#           layout=c(1,4),
#           col="#3166A9",
#           main="Change in DOC by Nutrient Treatment")

# Change stripchart colors by groups
ggplot(expchem_trim, aes(x=treatment, y=changeDOC_mgL, color=treatment)) +
   geom_boxplot(position=position_dodge(0.8))+
    geom_jitter(position=position_jitter(0.2))+
  scale_color_manual(values=trtcolors)+
  facet_wrap(.~temperature)+
  theme_bw()
```

```{r, echo=FALSE, tidy=TRUE, fig.width=10}

#Bar plot - Net DOC release
ggplot(expchem_changesummary, aes(x=treatment, y=meanchangeDOC_mgL, fill=treatment)) + theme_bw()+
   geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\nTreatment",
                    labels=c("Control", "Nitrogen", "Phosphorus", "Both (N & P)"))+
  geom_errorbar(aes(ymin=meanchangeDOC_mgL-sdchangeDOC_mgL, ymax=meanchangeDOC_mgL+sdchangeDOC_mgL),
                width=.2,
                position=position_dodge(0.9))+
  coord_cartesian(ylim=c(0,5))+
  scale_y_continuous(breaks=seq(0,5,1))+
    facet_wrap( ~ temperature, ncol=3, scales="free")+
  # geom_hline(yintercept=66) +
  # annotate("text",1,66,vjust=-1,label="  Starting [TDN] in N & N+P treatments")+
  # geom_hline(yintercept=18, color="black", linetype="dashed")+
  # annotate("text",0.8,18,vjust=-1,label="Background [TDN]")+
  labs(x="Temperature Treatment",y="Net change in DOC (mg/L)", title="")

# ggsave("DOCrelease.png", width=10, height=5,units="in")



```

> Does this match what we see in the pairwise comparisons? 

#### DOC exudation - ANOVA results - with intxn
From our preliminary glance at the data, it looks like at lower temperatures, there is more DOC released (still pondering the ecological significance of that... fueling microbial loop?). At higher temperatures, it looks like there is less DOC at the end of the experiment, but it varies by nutrient treatment. 


**Log transformed DOC model**
```{r DOC ANOVA Type II, echo=FALSE, tidy=TRUE}
DOC_Model1 <- lm(log(changeDOC_mgL) ~  temperature * treatment -1, data=expchem_trim)
library(emmeans) #Estimated Marginal Means
emmip(DOC_Model1, temperature ~ treatment)
emmip(DOC_Model1, treatment~temperature)
Anova(DOC_Model1, type=3, contrasts=c("constr.sum","contr.poly"))

#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 
```

> Studying the output of the ANOVA table (Type III SS), we see there is a evidence of a  significant interaction effect (F(6,59)=3.4983, p=0.005007). The test for the main effect of temperature treatment is significant (p=< 0.0001) but the test for the main effect of nutrient treatment alone is not significant (p=0.330755).  After fitting an ANOVA model it is important to always check the relevant model assumptions.  This includes making QQ-plots and residual plots. Will use Levene's test of equality of variances too. 

**Log transformed DOC**
```{r DOC qqplots and residuals, echo=FALSE, tidy=TRUE}
qqnorm(DOC_Model1$res)
plot(DOC_Model1$fitted,DOC_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(changeDOC_mgL ~ treatment * temperature,data=expchem_trim)
```

> Overall, neither plot indicates a significant violation of normality assumptions. We're good here.

```{r DOC model without outlier, echo=FALSE, tidy=TRUE}
expchem_trim_DOCoutlier <- expchem_trim %>%
  filter(changeDOC_mgL < 5)
DOC_Model2 <- lm(changeDOC_mgL ~  temperature * treatment -1, data=expchem_trim_DOCoutlier)
library(emmeans) #Estimated Marginal Means
emmip(DOC_Model2, temperature ~ treatment)
emmip(DOC_Model2, treatment~temperature)
Anova(DOC_Model2, type=3, contrasts=c("constr.sum","contr.poly"))
qqnorm(DOC_Model2$res)
plot(DOC_Model2$fitted,DOC_Model2$res,xlab="Fitted",ylab="Residuals")
leveneTest(changeDOC_mgL ~ treatment * temperature,data=expchem_trim_DOCoutlier)
```

> If we take the one super high DOC value out and don't log transform, we meet the assumptions of normality. Not sure if this is really ethical though. Which sample was that??

```{r, tidy=TRUE}
expchem_trim %>%
  select(sample_id, changeDOC_mgL) %>%
  filter(changeDOC_mgL > 5)
```

####DOC exudation - Pairwise comparisons


```{r DOC pairwise trt x temp , echo=FALSE, tidy=TRUE}
library(emmeans) #Estimated Marginal Means
emms_DOC_trtxtemp <- emmeans(DOC_Model2, pairwise ~ treatment | temperature)
emms_DOC_trtxtemp

```

>Pairwise comparsions for each level of temperature. At 12 degrees, we see significnant differences between C - NP, N - P, and N - NP. At 16 degress, there is a difference between C - P, C-NP, N-P, N-NP. There are no differences at 8 degrees. 

```{r, echo=FALSE, tidy=TRUE}
#Box plot with means comparisons
compare_means(changeDOC_mgL ~ treatment ,  data = expchem_trim_DOCoutlier, group.by="temperature")
DOC_comparisons <- list(c("C","P"),c("C","NP"), c("P", "NP"),c("N","P"))
ggplot(expchem_trim_DOCoutlier, aes(x=treatment, y=changeDOC_mgL, fill=treatment)) +
  geom_boxplot()+
  stat_boxplot(geom ='errorbar') +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\nTreatment",
                    labels=c("Control", "Nitrogen", "Phosphorus", "N&P"))+
  # coord_cartesian(ylim=c(0,5))+
  # scale_y_continuous(breaks=seq(0, 5, 1))+
  stat_compare_means(comparisons=DOC_comparisons, label="p.signif", group.by="temperature")+
  stat_compare_means(label.y=0.25)+
  facet_wrap(~temperature)+
  labs(x="Incubation temperature",y="Net change in DOC (mg/L)")


```

```{r, echo=FALSE, tidy=TRUE}
emms_DOC_tempxtrt <- emmeans(DOC_Model2, pairwise ~ temperature | treatment)
emms_DOC_tempxtrt
#Pairwise comparsions for each level of temperature
```

> In the control, there is a difference between 8 and 12 and 12 and 16. In the N trt, there is a difference btwn 8 vs 12 and 12 vs 16. In the P trt, there is a difference between 8 vs 12, and 8 vs 16. In the NP trt, there is a difference between 8 vs 12, and 8 vs 16. 


####DOC exudation - Plot of temperature effect
```{r temperature effect}


#Box plots all nutrient treatments aggregated by temperature
compare_means(changeDOC_mgL ~ temperature ,  data = expchem_trim)
temp_DOC_comparisons <- list(c("8","12"),c("8","16"))
DOCrelease_temp_boxplot <- ggplot(expchem_trim, aes(x=temperature, y=changeDOC_mgL, fill=temperature)) +
  geom_boxplot()+
  geom_point(size=3, alpha=0.4,position = position_jitter()) +
  stat_boxplot(geom ='errorbar') +
  # scale_fill_manual(values=trtcolors,
  #                   name="Nutrient\nTreatment",
  #                   labels=c("Control", "Nitrogen", "Phosphorus", "N&P"))+
  coord_cartesian(ylim=c(0,5))+
  scale_y_continuous(breaks=seq(0, 5, 1), name="Net change DOC (mg/L)")+
  stat_compare_means(comparisons=temp_DOC_comparisons, label="p.signif")+
  stat_compare_means(label.y=5)+
  labs(x="Temperature")
DOCrelease_temp_boxplot
# ggsave("DOCchange_bytemp.png", width=9.5, height=5,units="in")
```


### Data Visualization - PO4 uptake/release

Before we jump into any statistical analyses, just want to get an idea of how things play out by treatment and temperature .

#### PO4 uptake/release - Data table summary
```{r data table summary all treatments and nutrients PO4, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}

expchem_changesummary %>%
  select(treatment, temperature, meanchangePO4_uM, sdchangePO4_uM, n) %>%
  kable("html", digits=3, caption="Incubation experiment nutrient data summary: means, standard deviation, and number of replicates per treatment") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = F, position="left", font_size=12)
```

####PO4 uptake/release - Descriptive statistics and plots
Here we have some summary statistics for PO4 uptake/release. First we are looking at change in PO4 from start to end of experiment by TEMPERTURE and by TREATMENT separately. I've also plotted boxplots with individual points. Due to the way I calculated these values (Initial PO4 minus final PO4), negative numbers here mean there is MORE phosphate at the end of the experiment than the begining. Positive number indiciate uptake... slightly counterintuitive.

```{r histograms of each group PO4, echo=FALSE, message=FALSE, warning=FALSE, tidy=TRUE}
library(DescTools)
Desc(changePO4_uM ~ temperature, data=expchem_trim, digits=1, plotit=TRUE)
Desc(changePO4_uM ~ treatment, data=expchem_trim, digits=1, plotit=TRUE)

# Change stripchart colors by groups
# ggplot(expchem_trim, aes(x=temperature, y=changePO4_uM, color=treatment)) +
#    geom_boxplot(position=position_dodge(0.8))+
#     geom_jitter(position=position_jitter(0.2))+
#   scale_color_manual(values=trtcolors)+
#   theme_classic2(base_size=16)


ggplot(expchem_changesummary, aes(x=treatment, y=meanchangePO4_uM, fill=treatment)) + theme_bw()+
  geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\nTreatment\n",
                    labels=c("Control\n", "Nitrogen\n", "Phosphorus\n", "Both (N & P)\n"))+
  geom_errorbar(aes(ymin=meanchangePO4_uM-sdchangePO4_uM, ymax=meanchangePO4_uM+sdchangePO4_uM),
                width=.2,
                position=position_dodge(0.9))+
  coord_cartesian(ylim=c(-10,10))+
  scale_y_continuous(breaks=seq(-10,10,1))+
  facet_wrap( ~ temperature, ncol=3, scales="free")+
  # geom_hline(yintercept=66) +
  # annotate("text",1,66,vjust=-1,label="  Starting [TDN] in N & N+P treatments")+
  # geom_hline(yintercept=18, color="black", linetype="dashed")+
  # annotate("text",0.8,18,vjust=-1,label="Background [TDN]")+
  labs(x="Temperature Treatment",y=" [uM PO4]", title="Change in PO4 from start to end of experiment")

# ggsave("PO4_change.png", width=20, height=12,units="in")

```


#### PO4 uptake/release - ANOVA results - with intxn
From our preliminary glance at the data, it looks like PO4 was released (averaging over all nutrient treatments). Interestingly, in the P & NP treatments, there was PO4 uptake compared to C & N treatments, where there was more PO4 leftover in the begining of the experiment than there were at the beginning.  


```{r PO4 ANOVA Type II, echo=FALSE, tidy=TRUE}
PO4_Model1 <- lm(changePO4_uM ~  temperature * treatment -1, data=expchem_trim)
library(emmeans) #Estimated Marginal Means
emmip(PO4_Model1, temperature ~ treatment)
emmip(PO4_Model1, treatment~temperature)
Anova(PO4_Model1, type=3, contrasts=c("constr.sum","contr.poly"))

#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 
```

Studying the output of the ANOVA table (Type III SS), we see there is a evidence of a marginally significant interaction effect (F(6,59)=9.6131, p<0.0001). The tests for the main effects of temperature and nutrient treatments are BOTH significant. After fitting an ANOVA model it is important to always check the relevant model assumptions.  This includes making QQ-plots and residual plots. Will use Levene's test of equality of variances too. 

```{r PO4 qqplots and residuals, echo=FALSE, tidy=TRUE}
qqnorm(PO4_Model1$res)
plot(PO4_Model1$fitted,PO4_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(changePO4_uM ~ treatment * temperature,data=expchem_trim)
```

PO4 uptake does not pass the Levene's test and the Normal Q-Q plot doesn't look good. We can try log transforming the data and see if that helps.



```{r PO4 ANOVA Type II Model 2, echo=FALSE, tidy=TRUE}
expchem_trim <- expchem_trim %>%
  mutate(log_changePO4_uM = log10(changePO4_uM+1-min(changePO4_uM)))

         
PO4_Model2 <- lm(log_changePO4_uM ~  temperature * treatment, data=expchem_trim)
Anova(PO4_Model2, type=3, contrasts=c("constr.sum","contr.poly"))
qqnorm(PO4_Model2$res)
plot(PO4_Model2$fitted,PO4_Model2$res,xlab="Fitted",ylab="Residuals")
leveneTest(log_changePO4_uM ~ treatment * temperature,data=expchem_trim)
```

 > This is slightly better, but there is still quite a bit spread in our residuals which is making us fail the Levene test. Might need to think of a workaround here. What if we look at % of P taken up or released? 

####PO4 uptake/release - Pairwise comparisons


```{r PO4 pairwise trt x temp , echo=FALSE, tidy=TRUE}
library(emmeans) #Estimated Marginal Means
emms_PO4_trtxtemp <- emmeans(PO4_Model2, pairwise ~ treatment | temperature)
emms_PO4_trtxtemp
#Pairwise comparsions for each level of temperature
```

>Pairwise comparsions for each level of temperature. At 8 degrees, sig diff between C and all treatments, N vs P, and N vs NP. At 12 degrees, all combos are significant except C vs N and P vs NP.  At 16 degrees, sig diff between C vs P, C vs NP, N vs P, N vs NP. 


 
```{r PO4 pairwise temp x trt, echo=FALSE, tidy=TRUE}
emms_PO4_tempxtrt <- emmeans(PO4_Model2, pairwise ~ temperature | treatment)
emms_PO4_tempxtrt

```

> Pairwise comparsions for each level of nutrient treatment. In the control nutrient treatment, there is a different between 8 and 16 degrees and 12 and 16 degrees. In the nitrogen nutrient treatment, there is a statistically significant difference with temperature. In the P treatment, there is a statastically significant difference between 8 and 12 and 8 and 16, but not between 12 and 16. Finally, in the NP treatment, therre is a difference between 8 and 12 and 8 and 16, but not between 12 and 16.

#### PO4 uptake/release - Two-way ANOVA with Robust Estimation
Tutorial found here: http://rcompanion.org/rcompanion/d_08a.html
More info on non-parametric tests and R packages here: https://journal.r-project.org/archive/2016/RJ-2016-027/RJ-2016-027.pdf

First, Produce Huber M-estimators and confidence intervals by group
NOT PRINTING AT THIS TIME
```{r PO4 Huber M-estimators, echo=FALSE, tidy=TRUE}
# library(WRS2)
# # The est = "mom" option uses a modified M-estimator for the analysis.  To analyze using medians, use the est= "median" option in the pbad2way function in the WRS2 package.  To analyze using trimmed means, use the t2way function in the WRS2 package.
# pbad2way(changePO4_uM ~  temperature * treatment, data=expchem_trim,
#          est="mom",
#          nboot=599,
#          pro.dis=TRUE)
# 
# #Produce post-hoc tests for main effects with mcp2a
# post_PO4 = mcp2a(changePO4_uM ~  temperature * treatment, 
#              data = expchem_trim,
#              est = "mom",    # M-estimator
#              nboot = 5000)   # number of bootstrap samples
# 
# post_PO4$contrasts
# 
# post_PO4
# 
# #Produce post-hoc tests for main effects with pairwiseRobustTest or pairwiseRobustMatrix
# ### Order groups by median
# expchem_trim$temperature = factor(expchem_trim$temperature, 
#                      levels = c("8", "12", "16"))
# 
# ### Pairwise robust test
# 
# library(rcompanion)
# 
# PT = pairwiseRobustTest(
#      changePO4_uM ~ temperature, 
#      data = expchem_trim,
#      est="mom", 
#      nboot=5000,
#      method="fdr")      # adjust p-values; see ?p.adjust for options
# 
# PT
# 
# ### Produce compact letter display 
# 
# cldList(comparison = PT$Comparison,
#         p.value    = PT$p.adjust,
#         threshold  = 0.05)
# 
# #Produce post-hoc tests for interaction effect
# 
# ### Create a factor which is the interaction of Factor.A and Factor.B
# 
# expchem_trim$Factor.int = interaction (expchem_trim$temperature, expchem_trim$treatment)
# glimpse(expchem_trim)
# 
# ### Order groups by median
# 
# expchem_trim$Factor.int = factor(expchem_trim$Factor.int,
#                          levels = c("8.C","12.C", "16.C",
#                                   "8.N","12.N","16.N",
#                                   "8.P","12.P","16.P",
#                                   "8.NP","12.NP","16.NP"))
# 
# 
# ### Check data frame
# 
# library(psych)
# 
# headTail(expchem_trim)
# 
# PT_2 = pairwiseRobustTest(
#      changePO4_uM ~ Factor.int, 
#      data = expchem_trim,
#      est="mom", 
#      nboot=5000,
#      method="fdr")      # adjust p-values; see ?p.adjust for options
# 
# PT_2
```


####PO4 concentrations experiment end - Descriptive statistics and plots
Here we have some summary statistics for PO4 uptake/release. First we are looking at change in PO4 from start to end of experiment by TEMPERTURE and by TREATMENT separately. I've also plotted boxplots with individual points. Due to the way I calculated these values (Initial PO4 minus final PO4), negative numbers here mean there is MORE phosphate at the end of the experiment than the begining. Positive number indiciate uptake... slightly counterintuitive.

```{r histograms of each group PO4 2, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
library(DescTools)
expchem$temperature <- as.factor(expchem$temperature)
Desc(PO4_uM ~ temperature, data=expchem, digits=1, plotit=TRUE)
Desc(PO4_uM ~ treatment, data=expchem, digits=1, plotit=TRUE)




  ggplot(expchem, aes(x=temperature, y=PO4_uM, fill=treatment)) +
  geom_boxplot()+
  stat_boxplot(geom ='errorbar') +
  # geom_point(size=3, alpha=0.4,position = position_jitter()) +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\nTreatment",
                    labels=c("Control", "Nitrogen", "Phosphorus", "N&P"))+
  # coord_cartesian(ylim=c(0,5))+
  # scale_y_continuous(breaks=seq(0, 5, 1))+
  labs(x="Incubation temperature",y="PO4 end (uM)") 

# ggsave("PO4_end_boxplot1.png", width=9, height=7,units="in")


  ggplot(expchem, aes(x=treatment, y=PO4_uM, fill=temperature)) +
  geom_boxplot()+
  stat_boxplot(geom ='errorbar') +
  # geom_point(size=3, alpha=0.4,position = position_jitter()) +
  # scale_fill_manual(values=trtcolors,
  #                   name="Nutrient\nTreatment",
  #                   labels=c("Control", "Nitrogen", "Phosphorus", "N&P"))+
  # coord_cartesian(ylim=c(0,5))+
  # scale_y_continuous(breaks=seq(0, 5, 1))+

  labs(x="Treatment",y="PO4 end (uM)") 

# ggsave("PO4_end_boxplot2.png", width=9, height=7,units="in")


```



### Data Visualization - Beaker Chla

Before we jump into any statistical analyses, just want to get an idea of how things play out by treatment and temperature .

#### Beaker Chla - Data table summary
```{r data table summary all treatments and nutrients phyto, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}

expchem_changesummary %>%
  select(treatment, temperature, meanphytochla, sdphytochla, n) %>%
  kable("html", digits=3, caption="Incubation experiment nutrient data summary: means, standard deviation, and number of replicates per treatment") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = F, position="left", font_size=12)
```

####Beaker Chla - Descriptive statistics and plots
Here we have some summary statistics for Beaker Chla. First we are looking at how much chlorophyll a there was in the beaker at the end of experiment by TEMPERTURE and by TREATMENT separately. I've also plotted boxplots with individual points. Not sure where all these phytoplankton came from, since we used filtered lake water. 

```{r histograms of each group chla, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
library(DescTools)
Desc(chl_a_phyto ~ temperature, data=expchem_trim, digits=1, plotit=TRUE)
Desc(chl_a_phyto ~ treatment, data=expchem_trim, digits=1, plotit=TRUE)


# Change stripchart colors by groups
ggplot(expchem_trim, aes(x=temperature, y=chl_a_phyto, color=temperature)) +
  geom_boxplot(position=position_dodge(0.8))+
  geom_jitter(position=position_jitter(0.2))+
  scale_color_manual(values=tempcolors)+
  facet_wrap(~treatment)+
  theme_bw()

ggplot(expchem_trim, aes(x=treatment, y=chl_a_phyto, color=treatment)) +
  geom_boxplot(position=position_dodge(0.8))+
  geom_jitter(position=position_jitter(0.2))+
  scale_color_manual(values=trtcolors)+
  facet_wrap(~temperature)+
  theme_bw()
```


#### Beaker Chla - ANOVA results - with intxn
From our preliminary glance at the data, it doesn't look like there is much a difference in the means, although in the 8 degree treatments, the spread was quite wide. Comparing across nutrient treatments, NP has the highest mean chla with N as the runner up.


```{r chla ANOVA Type II, echo=FALSE, tidy=TRUE}
Phyto_Chla_Model1 <- lm(chl_a_phyto ~  temperature * treatment -1, data=expchem_trim)
library(emmeans) #Estimated Marginal Means
emmip(Phyto_Chla_Model1, temperature ~ treatment)
emmip(Phyto_Chla_Model1, treatment~temperature)
Anova(Phyto_Chla_Model1, type=3, contrasts=c("constr.sum","contr.poly"))

#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 
```

> Studying the output of the ANOVA table (Type III SS), we see there is a evidence of a significant interaction effect (F(6,59)=12.783, p<0.0001). The tests for the main effects of temperature is not significant, but the effect ot treatment is highly significant (F(3,59)=70.436, p<0.0001).

After fitting an ANOVA model it is important to always check the relevant model assumptions.  This includes making QQ-plots and residual plots. Will use Levene's test of equality of variances too. 

```{r chla qqplots and residuals, echo=FALSE, tidy=TRUE}
qqnorm(Phyto_Chla_Model1$res)
plot(Phyto_Chla_Model1$fitted,Phyto_Chla_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(chl_a_phyto ~ treatment * temperature,data=expchem_trim)
```

> Data fit the model assumptions. We can move on.


####Beaker Chla - Pairwise comparisons

Pairwise comparsions for each level of temperature. At 8 degrees, NP is different than C, N, and P. At 12 degrees, NP is different than C, N, and P. At 16 degrees, both N and NP are significantly different than the Control. N vs P and P versus NP are both significantly different from each other, but N and NP are not significantly different.
```{r chla pairwise trt x temp , echo=FALSE, tidy=TRUE}
library(emmeans) #Estimated Marginal Means
emms_phyto_chla_trtxtemp <- emmeans(Phyto_Chla_Model1, pairwise ~ treatment | temperature)
emms_phyto_chla_trtxtemp
#Pairwise comparsions for each level of temperature
```

Pairwise comparsions for each level of nutrient treatment. In the control nutrient treatment, there is a different between 8 and 16 degrees and 12 and 16 degrees. In the nitrogen nutrient treatment, there is a statistically significant difference with temperature. In the P treatment, there is a statastically significant difference between 8 and 12 and 8 and 16, but not between 12 and 16. Finally, in the NP treatment, therre is a difference between 8 and 12 and 8 and 16, but not between 12 and 16. 
```{r chla pairwise temp x trt, echo=FALSE, tidy=TRUE}
emms_PO4_tempxtrt <- emmeans(PO4_Model2, pairwise ~ temperature | treatment)
emms_PO4_tempxtrt
#Pairwise comparsions for each level of nutrient treatment
# cld(emms_TDN_tempxtrt) # implicitly uses by "temperature"
#cld(emms_TDN_tempxtrt, by=NULL, Letters= "||||||||", alpha=0.01)
```



## NEP/ER/GPP Assays


```{r load incubation data GPP/ER, warning=FALSE, message=FALSE, echo=FALSE, tidy=TRUE, include=FALSE}
incubation <- read.csv("data_clean/incubationdata_GPP_180523.csv")

incubation <- as.tbl(incubation)
glimpse(incubation)

incubation <- incubation %>%
  mutate(NEP_ugcm2h = NEP_mgcm2h *1000,
         ER_ugcm2h = ER_mgcm2h * 1000,
         GPP_ugcm2h = GPP_mgcm2h *1000) 

#Which samples had positive ER? Actually impossible...
incubation %>% 
  filter(ER_ugcm2h > 0)
#8C-1, 8C-2, 8C-3

#Replace positive values with -0.1
incubation <- incubation %>%
  rename(ER_ugcm2h_old = ER_ugcm2h) %>% 
  select(-ER_mgcm2h, -NEP_mgcm2h,GPP_mgcm2h ) %>% # get rid of mg columns
  mutate(ER_ugcm2h = ER_ugcm2h_old) %>% #duplicate ER column
  mutate(ER_ugcm2h = replace(ER_ugcm2h, ER_ugcm2h > 0, -0.1)) %>%
  rename(NEP_ugcm2h_old = NEP_ugcm2h) %>%
  mutate(NEP_ugcm2h = ER_ugcm2h + GPP_ugcm2h) #calculate NEP again (GPP + R)
  

incubation_summary <- incubation %>%
  group_by(treatment, temperature) %>%
  summarize(meanNEP=mean(NEP_ugcm2h),
            sdNEP=sd(NEP_ugcm2h),
            meanER=mean(ER_ugcm2h),
            sdER=sd(ER_ugcm2h),
            meanGPP=mean(GPP_ugcm2h),
            sdGPP=sd(GPP_ugcm2h),
            n = n()) %>%
  arrange(temperature)
incubation_summary

#Specify temperature as factor
incubation_summary$temperature <- as.factor(incubation_summary$temperature)
incubation_summary$treatment <- factor(incubation_summary$treatment, levels=c('C','N','P',
                                               'NP'))
incubation$temperature <- as.factor(incubation$temperature)
incubation$treatment <- factor(incubation$treatment, levels=c('C','N','P',
                                               'NP'))

trtcolors <- c("#40A339", "#3166A9", "#DE0019", "#82388E") #treatment colors
tempcolors <- c( "#3166A9", "#40A339","#DE0019") #treatment colors
```


### Data Visualization - GPP (gross primary production)

Before we jump into any statistical analyses, just want to get an idea of how things play out by treatment and temperature .

#### GPP - Data table summary
```{r data table summary all treatments and nutrients GPP, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}

incubation_summary %>%
  select(treatment, temperature, meanGPP, sdGPP, n) %>%
  kable("html", digits=3, caption="Incubation experiment GPP data summary: means, standard deviation, and number of replicates per treatment") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = F, position="left", font_size=12)
```

####GPP - Descriptive statistics and plots
Here we have some summary statistics for GPP. First we are looking at GPP by TEMPERTURE and by TREATMENT separately.

```{r histograms of each group GPP, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
library(DescTools)
Desc(GPP_ugcm2h ~ temperature, data=incubation, digits=1, plotit=TRUE)
Desc(GPP_ugcm2h ~ treatment, data=incubation, digits=1, plotit=TRUE)

# Change stripchart colors by groups
ggplot(incubation, aes(x=treatment, y=GPP_ugcm2h, color=treatment)) +
  geom_boxplot(position=position_dodge(0.6))+
  geom_jitter(position=position_jitter(0.6))+
  scale_color_manual(values=trtcolors)+
  facet_wrap(~temperature)+
  theme_bw()

ggplot(incubation, aes(x=temperature, y=GPP_ugcm2h, color=temperature)) +
  geom_boxplot(position=position_dodge(0.6))+
  geom_jitter(position=position_jitter(0.6))+
  scale_color_manual(values=tempcolors)+
  facet_wrap(~treatment)+
  theme_bw()


```


#### GPP - ANOVA results - with intxn
From our preliminary glance at the data, it looks like GPP might be higher on average in the warmest temperature treatment (16 degrees). As for the nutrients, it the controls have the widest spread in GPP and as a result have the highest mean.


```{r GPP ANOVA Type II, echo=FALSE, tidy=TRUE}
GPP_Model1 <- lm(GPP_ugcm2h ~  temperature * treatment-1, data=incubation)
library(emmeans) #Estimated Marginal Means
emmip(GPP_Model1, temperature ~ treatment)
emmip(GPP_Model1, treatment~temperature)
Anova(GPP_Model1, type=3, contrasts=c("constr.sum","contr.poly"))

#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 
```

Studying the output of the ANOVA table (Type III SS), we see there is a evidence of a significant interaction effect (F(6,60)=3.0340, p=0.011710). The tests for the main effects of treatment is not significant, but the effect of temperature is significant (F(3,60)=167.7790, p< 0.0001).

After fitting an ANOVA model it is important to always check the relevant model assumptions.  This includes making QQ-plots and residual plots. Will use Levene's test of equality of variances too. 

```{r GPP qqplots and residuals, echo=FALSE, tidy=TRUE}
qqnorm(GPP_Model1$res)
plot(GPP_Model1$fitted,GPP_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(GPP_ugcm2h ~  temperature * treatment, data=incubation)
```

>Data appear to fit model assumptions

####GPP - Pairwise comparisons


```{r GPP pairwise trt x temp , echo=FALSE, tidy=TRUE}
library(emmeans) #Estimated Marginal Means
emms_GPP_trtxtemp <- emmeans(GPP_Model1, pairwise ~ treatment | temperature)
emms_GPP_trtxtemp
#Pairwise comparsions for each level of temperature
```

>Pairwise comparsions for each level of temperature. At 8 degrees, there is no difference between treatments. At 12 degrees, the Control is different than all the other nutrient treatments. And at 16 degrees there is no difference between treatments.


```{r GPP pairwise temp x trt, echo=FALSE, tidy=TRUE}
emms_GPP_tempxtrt <- emmeans(GPP_Model1, pairwise ~ temperature | treatment)
emms_GPP_tempxtrt

```

>Pairwise comparsions for each level of nutrient treatment. In the control treatment, there is a difference between 8 and 12 and 8 and 16, but none between 12 and 16. In the nitrogen treatment, there is a different between 8 and 16 ad 12 and 16, but not between 8 and 12. In the P treatment, there are no differences between temperatures. In the NP treatment, there is a difference between 12 and 16 but none between 8 and 12. 


```{r final GPP figure, echo=FALSE, tidy=TRUE}


ggplot(incubation_summary, aes(x=treatment, y=meanGPP, fill=treatment)) + theme_bw()+
   geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\namendment",
                    labels=c("Control", "Nitrogen", "Phosphorus", "Both (N & P)"))+
  geom_errorbar(aes(ymin=meanGPP-sdGPP, ymax=meanGPP+sdGPP),
                width=.2,
                position=position_dodge(0.9))+
  # coord_cartesian(ylim=c(0,0.5))+
  # scale_y_continuous(breaks=seq(0,0.5,0.1))+
  facet_wrap( ~ temperature , ncol=3, scales="free_y")+
  labs(x="",y=" (mg O2/cm2/h)", title="GPP")+
  theme(legend.position="bottom",
      axis.text.x=element_blank())


ggplot(incubation_summary, aes(x=temperature, y=meanGPP, fill=temperature)) + theme_bw()+
   geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=tempcolors,
                    name="Temperature\ntreatment",
                    labels=c("8", "12", "16"))+
  geom_errorbar(aes(ymin=meanGPP-sdGPP, ymax=meanGPP+sdGPP),
                width=.2,
                position=position_dodge(0.9))+
  # coord_cartesian(ylim=c(0,0.5))+
  # scale_y_continuous(breaks=seq(0,0.5,0.1))+
  facet_wrap( ~ treatment , ncol=4, scales="free_y")+
  labs(x="",y=" (mg O2/cm2/h)", title="GPP")+
  theme(legend.position="bottom",
      axis.text.x=element_blank())

```



### Data Visualization - ER (microbial respiration)

Before we jump into any statistical analyses, just want to get an idea of how things play out by treatment and temperature .

#### ER - Data table summary
```{r data table summary all treatments and nutrients ER, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}

incubation_summary %>%
  dplyr::select(treatment, temperature, meanER, sdER, n) %>%
  kable("html", digits=3, caption="Incubation experiment ER data summary: means, standard deviation, and number of replicates per treatment") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = F, position="left", font_size=12)
```

####ER - Descriptive statistics and plots
Here we have some summary statistics for ER. First we are looking at ER by TEMPERTURE and by TREATMENT separately.

```{r histograms of each group ER, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
library(DescTools)
Desc(ER_ugcm2h ~ temperature, data=incubation, digits=1, plotit=TRUE)
Desc(ER_ugcm2h ~ treatment, data=incubation, digits=1, plotit=TRUE)


# Change stripchart colors by groups
ggplot(incubation, aes(x=treatment, y=ER_ugcm2h, color=treatment)) +
   geom_boxplot(position=position_dodge(0.6))+
    geom_jitter(position=position_jitter(0.6))+
  scale_color_manual(values=trtcolors)+
  facet_wrap(~temperature)+
  theme_bw()

```


#### ER - ANOVA results - with intxn


```{r ER ANOVA Type II, echo=FALSE, tidy=TRUE}
ER_Model1 <- lm(ER_ugcm2h ~  temperature * treatment-1, data=incubation)
library(emmeans) #Estimated Marginal Means
emmip(ER_Model1, temperature ~ treatment)
emmip(ER_Model1, treatment~temperature)
Anova(ER_Model1, type=3, contrasts=c("constr.sum","contr.poly"))

#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 
```
<From our preliminary glance at the data, it looks like ER might be higher on average in the warmest temperature treatment (16 degrees). As for the nutrients, the control has the widest spread in ER, but the highest mean ER is in the N treatment.

Studying the output of the ANOVA table (Type III SS), we see there is a evidence of a significant interaction effect (F(6,60)=8.1363, p<0.0001). The tests for the main effects of temperature treatment is significant (F(3,60)=116.1382, p<0.00001) and so is nutrient treatment (F(3,60)=9.5048, p<0.0001.)

After fitting an ANOVA model it is important to always check the relevant model assumptions.  This includes making QQ-plots and residual plots. Will use Levene's test of equality of variances too. 

```{r ER qqplots and residuals, echo=FALSE, tidy=TRUE}
qqnorm(ER_Model1$res)
plot(ER_Model1$fitted,ER_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(ER_ugcm2h ~  temperature * treatment, data=incubation)
```

>Looks like we meet the assumptions of normality so we can move onto pairwise comparisons. 

####ER - Pairwise comparisons


```{r ER pairwise trt x temp , echo=FALSE, tidy=TRUE}
library(emmeans) #Estimated Marginal Means
emms_ER_trtxtemp <- emmeans(ER_Model1, pairwise ~ treatment | temperature)
emms_ER_trtxtemp
#Pairwise comparsions for each level of temperature
```
>Pairwise comparsions for each level of temperature. At 8 degrees, there is a difference between the control and all nutrient treatments, but not between nutrient treatments. At 12 degrees, there is a different between C - N and C - NP. At 16 degrees, there is no statistically significant relationship between nutrient treatments.


```{r ER pairwise temp x trt, echo=FALSE, tidy=TRUE}
emms_ER_tempxtrt <- emmeans(ER_Model1, pairwise ~ temperature | treatment)
emms_ER_tempxtrt
#Pairwise comparsions for each level of nutrient treatment
# cld(emms_TDN_tempxtrt) # implicitly uses by "temperature"
#cld(emms_TDN_tempxtrt, by=NULL, Letters= "||||||||", alpha=0.01)
```
>Pairwise comparsions for each level of nutrient treatment. In the control treatment, there is a difference between 8 - 12, 8 - 16, and between 12 - 16. In the N treatment, there is no difference between 8 and 12, but there is a difference between 8 - 16 and 12 - 16. In the P treatment, there is a difference between 8 - 16 and 12- 16. Lastly, in the NP treatment, there is a difference between 8 - 12, 8 - 16, and 12 - 16. 


```{r final ER figure, echo=FALSE, tidy=TRUE}

ggplot(incubation_summary, aes(x=treatment, y=meanER, fill=treatment)) + theme_bw()+
   geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\namendment",
                    labels=c("Control", "Nitrogen", "Phosphorus", "Both (N & P)"))+
  geom_errorbar(aes(ymin=meanER-sdER, ymax=meanER+sdER),
                width=.2,
                position=position_dodge(0.9))+
  facet_wrap( ~ temperature , ncol=3, scales="free_y")+
  labs(x="",y=" (mg O2/cm2/h)", title="ER")+
  theme(legend.position="bottom",
      axis.text.x=element_blank())

ggplot(incubation_summary, aes(x=temperature, y=meanER, fill=temperature)) + theme_bw()+
   geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=tempcolors,
                    name="Nutrient\namendment",
                    labels=c("Control", "Nitrogen", "Phosphorus", "Both (N & P)"))+
  geom_errorbar(aes(ymin=meanER-sdER, ymax=meanER+sdER),
                width=.2,
                position=position_dodge(0.9))+
  facet_wrap( ~ treatment , ncol=4, scales="free_y")+
  labs(x="",y=" (mg O2/cm2/h)", title="ER")+
  theme(legend.position="bottom",
      axis.text.x=element_blank())


```



### Data Visualization - NEP (net ecosystem production)

Before we jump into any statistical analyses, just want to get an idea of how things play out by treatment and temperature .

#### NEP - Data table summary
```{r data table summary all treatments and nutrients NEP, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}

incubation_summary %>%
  dplyr::select(treatment, temperature, meanNEP, sdNEP, n) %>%
  kable("html", digits=3, caption="Incubation experiment NEP data summary: means, standard deviation, and number of replicates per treatment") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = F, position="left", font_size=12)
```

####NEP - Descriptive statistics and plots
Here we have some summary statistics for NEP. First we are looking at NEP by TEMPERTURE and by TREATMENT separately.

```{r histograms of each group NEP, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
library(DescTools)
Desc(NEP_ugcm2h ~ temperature, data=incubation, digits=1, plotit=TRUE)
Desc(NEP_ugcm2h ~ treatment, data=incubation, digits=1, plotit=TRUE)

# Change stripchart colors by groups
ggplot(incubation, aes(x=treatment, y=NEP_ugcm2h, color=treatment)) +
  geom_boxplot(position=position_dodge(0.6))+
  geom_jitter(position=position_jitter(0.6))+
  scale_color_manual(values=trtcolors)+
  facet_wrap(~temperature)+
  theme_bw()

```


#### NEP - ANOVA results - with intxn
From our preliminary glance at the data, it looks like NEP might be higher on average in the warmest temperature treatment (16 degrees). As for the nutrients, it the controls have the widest spread in NEP and as a result have the highest mean.


```{r NEP ANOVA Type II, echo=FALSE, tidy=TRUE}
NEP_Model1 <- lm(NEP_ugcm2h ~  temperature * treatment-1, data=incubation)
library(emmeans) #Estimated Marginal Means
emmip(NEP_Model1, temperature ~ treatment)
emmip(NEP_Model1, treatment~temperature)
Anova(NEP_Model1, type=3, contrasts=c("constr.sum","contr.poly"))

#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 
```

Studying the output of the ANOVA table (Type III SS), we see there is a evidence of a significant interaction effect (F(6,60)=3.0340, p=0.011710). The tests for the main effects of treatment is not significant, but the effect of temperature is significant (F(2,60)=7.2577, p=0.001504).

After fitting an ANOVA model it is important to always check the relevant model assumptions.  This includes making QQ-plots and residual plots. Will use Levene's test of equality of variances too. 

```{r NEP qqplots and residuals, echo=FALSE, tidy=TRUE}
qqnorm(NEP_Model1$res)
plot(NEP_Model1$fitted,NEP_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(NEP_ugcm2h ~  temperature * treatment, data=incubation)
```
>Data appear to fit model assumptions

####NEP - Pairwise comparisons


```{r NEP pairwise trt x temp , echo=FALSE, tidy=TRUE}
library(emmeans) #Estimated Marginal Means
emms_NEP_trtxtemp <- emmeans(NEP_Model1, pairwise ~ treatment | temperature)
emms_NEP_trtxtemp
#Pairwise comparsions for each level of temperature
```
>Pairwise comparsions for each level of temperature. At 8 degrees, there is no difference between treatments. At 12 degrees, the Control is different than all the other nutrient treatments. And at 16 degrees there is no difference between treatments.


```{r NEP pairwise temp x trt, echo=FALSE, tidy=TRUE}
emms_NEP_tempxtrt <- emmeans(NEP_Model1, pairwise ~ temperature | treatment)
emms_NEP_tempxtrt

```
>Pairwise comparsions for each level of nutrient treatment. In the control treatment, there is a difference between 8 and 12 and 8 and 16, but none between 12 and 16. In the nitrogen treatment, there is a different between 8 and 16 ad 12 and 16, but not between 8 and 12. In the P treatment, there are no differences between temperatures. In the NP treatment, there is a difference between 12 and 16 but none between 8 and 12. 


```{r final NEP figure, echo=FALSE, tidy=TRUE}


ggplot(incubation_summary, aes(x=treatment, y=meanNEP, fill=treatment)) + theme_bw()+
   geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=trtcolors,
                    name="Nutrient\namendment",
                    labels=c("Control", "Nitrogen", "Phosphorus", "Both (N & P)"))+
  geom_errorbar(aes(ymin=meanNEP-sdNEP, ymax=meanNEP+sdNEP),
                width=.2,
                position=position_dodge(0.9))+
  # coord_cartesian(ylim=c(0,0.5))+
  # scale_y_continuous(breaks=seq(0,0.5,0.1))+
  facet_wrap( ~ temperature , ncol=3, scales="free_y")+
  labs(x="",y=" (mg O2/cm2/h)", title="NEP")+
  theme(legend.position="bottom",
      axis.text.x=element_blank())



ggplot(incubation_summary, aes(x=temperature, y=meanNEP, fill=temperature)) + theme_bw()+
   geom_bar(color="black",stat="identity", position="dodge") +
  scale_fill_manual(values=tempcolors,
                    name="Nutrient\namendment",
                    labels=c("8 deg C", "12 deg C", "16 deg C"))+
  geom_errorbar(aes(ymin=meanNEP-sdNEP, ymax=meanNEP+sdNEP),
                width=.2,
                position=position_dodge(0.9))+
  # coord_cartesian(ylim=c(0,0.5))+
  # scale_y_continuous(breaks=seq(0,0.5,0.1))+
  facet_wrap( ~ treatment , ncol=4)+
  labs(x="",y=" (mg O2/cm2/h)", title="NEP")+
  theme(legend.position="bottom",
      axis.text.x=element_blank())




```




## Pigment Results - BENTHIC


### Data Visualization - Pigments (Chla A)
```{r load pigment data & maniuplate a little, echo=FALSE, tidy=TRUE, warning=FALSE, message=FALSE}
TxN.raw <- read.csv("data_clean/TxN_withdilutions.csv")
TxN.data.trim <- TxN.raw %>%
  filter(!run_ID %in% c("6C", "7C", "8C","5C_rerun")) %>%
  filter(temperature %in% c("12","16"))%>%
  select(run_ID, temperature, sample_rep, treatment, pigment_ID, mass_ug_cm2) %>%
  filter(pigment_ID %in% c("chla","chlb")) #Since fuco, myxo, aphan had n of 1, only select chlb and chla

#Add in percent green algae of sample
library(reshape2)
#Data in long format. Need to go to wide format.
TxN.data.trim.wide <- dcast(TxN.data.trim, run_ID + temperature + treatment + sample_rep ~ pigment_ID, value.var="mass_ug_cm2") %>%
  arrange(temperature,treatment,run_ID) %>%
  mutate(perc_green = (chlb/chla)*100)
#Convert back to long format.
TxN.data.full = melt(TxN.data.trim.wide, id.vars = c("run_ID", "temperature", "treatment", "sample_rep"),
                     measure.vars = c("chla", "chlb",
                                      "perc_green")) %>%
  arrange(run_ID,treatment, temperature) %>%
  rename(pigment_ID = variable, #rename columns 
         mass_ug_cm2 = value)


TxN.data.summary <- TxN.data.full %>%
  group_by(pigment_ID, temperature, treatment) %>%
  summarize(mean_ug_cm2 = mean(mass_ug_cm2),
            sd_mass_ug_cm2=sd(mass_ug_cm2),
            n = n())

#Order the factors for graphing
TxN.data.summary$treatment = factor(TxN.data.summary$treatment, 
                                      levels=c('C','N','P',
                                               'NP'))
TxN.data.full$treatment = factor(TxN.data.full$treatment, 
                                         levels=c('C','N','P',
                                                  'NP'))

#Specify temperature as factor
TxN.data.full$temperature <- as.factor(TxN.data.full$temperature)
TxN.data.summary$temperature <- as.factor(TxN.data.summary$temperature)
TxN.data.trim.wide$temperature <- as.factor(TxN.data.trim.wide$temperature)

```

####Chl A Benthic -  Data table summary
The main thing to notice here compared to the other data is that our sample size is small (n=3 per trt combo)
```{r data table summary all treatments and nutrients pigments, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
TxN.data.summary %>%
  select(treatment, temperature, mean_ug_cm2, sd_mass_ug_cm2, n) %>%
  filter(pigment_ID=="chla") %>%
  kable("html", digits=3, caption="Incubation experiment pigment data summary: means, standard deviation, and number of replicates per treatment") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = F, position="left", font_size=12)
```

####Chl A Benethic- Descriptive statistics and plots
```{r histograms of each group ChlA, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
library(DescTools)
Desc(chla ~ temperature, data=TxN.data.trim.wide, digits=1, plotit=TRUE)
Desc(chla ~ treatment, data=TxN.data.trim.wide, digits=1, plotit=TRUE)

library(lattice)

histogram(~ chla | temperature, 
          data=TxN.data.trim.wide,
          layout=c(1,3),
          col="#3166A9",
          main="Chl A by Temperature")
histogram(~ chla | treatment, 
          data=TxN.data.trim.wide,
          layout=c(1,4),
          col="#3166A9",
          main="Chl A by Nutrient Treatment")
# Change stripchart colors by groups
ggplot(TxN.data.trim.wide, aes(x=temperature, y=chla, color=treatment)) +
   geom_boxplot(position=position_dodge(0.8))+
    geom_jitter(position=position_jitter(0.1))+
  scale_color_manual(values=c("#40A339", "#3166A9", "#DE0019", "#82388E"))+
  theme_classic2(base_size=16)

```

#### Chl A Benthic - ANOVA results - with intxn
```{r chl A ANOVA Type III, echo=FALSE, tidy=TRUE}
ChlA_Model1 <- lm(chla ~  temperature * treatment, data=TxN.data.trim.wide)
library(emmeans) #Estimated Marginal Means
emmip(ChlA_Model1, temperature ~ treatment)
emmip(ChlA_Model1, treatment~temperature)
Anova(ChlA_Model1, type=3, contrasts=c("constr.sum","contr.poly"))

#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 
```

Studying the output of the ANOVA table (Type III SS), <<womp womp>> it only thing that is significant is the intercept...whatever that means. 

```{r CHLA qqplots and residuals, echo=FALSE, tidy=TRUE}
qqnorm(ChlA_Model1$res)
plot(ChlA_Model1$fitted,ChlA_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(chla ~  temperature * treatment, data=TxN.data.trim.wide)
```

Looks like we meet the assumptions of normality, but no need to move onto pairwise comparisons. 


###Data Visualization - Pigments (Chl B)
####Chl B -  Data table summary
The main thing to notice here compared to the other data is that our sample size is small (n=3 per trt combo)
```{r data table summary all treatments and nutrients pigments CHLB, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
TxN.data.summary %>%
  select(treatment, temperature, mean_ug_cm2, sd_mass_ug_cm2, n) %>%
  filter(pigment_ID=="chlb") %>%
  kable("html", digits=3, caption="Incubation experiment pigment data summary: means, standard deviation, and number of replicates per treatment") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = F, position="left", font_size=12)
```

####Chl B - Descriptive statistics and plots
```{r histograms of each group ChlB, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
library(DescTools)
Desc(chlb ~ temperature, data=TxN.data.trim.wide, digits=1, plotit=TRUE)
Desc(chlb ~ treatment, data=TxN.data.trim.wide, digits=1, plotit=TRUE)

library(lattice)

histogram(~ chlb | temperature, 
          data=TxN.data.trim.wide,
          layout=c(1,3),
          col="#3166A9",
          main="Chl B by Temperature")
histogram(~ chlb | treatment, 
          data=TxN.data.trim.wide,
          layout=c(1,4),
          col="#3166A9",
          main="Chl B by Nutrient Treatment")
# Change stripchart colors by groups
ggplot(TxN.data.trim.wide, aes(x=temperature, y=chlb, color=treatment)) +
   geom_boxplot(position=position_dodge(0.8))+
    geom_jitter(position=position_jitter(0.1))+
  scale_color_manual(values=c("#40A339", "#3166A9", "#DE0019", "#82388E"))+
  theme_classic2(base_size=16)

```

#### Chl B - ANOVA results - with intxn
```{r chl B ANOVA Type III, echo=FALSE, tidy=TRUE}
ChlB_Model1 <- lm(chlb ~  temperature * treatment, data=TxN.data.trim.wide)
library(emmeans) #Estimated Marginal Means
emmip(ChlB_Model1, temperature ~ treatment)
emmip(ChlB_Model1, treatment~temperature)
Anova(ChlB_Model1, type=3, contrasts=c("constr.sum","contr.poly"))

#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 
```

Studying the output of the ANOVA table (Type III SS), <<womp womp>> nothing is significantly different.

```{r Chlb qqplots and residuals, echo=FALSE, tidy=TRUE}
qqnorm(ChlB_Model1$res)
plot(ChlB_Model1$fitted,ChlA_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(chlb ~  temperature * treatment, data=TxN.data.trim.wide)
```

Looks like we meet the assumptions of normality, but no need to move onto pairwise comparisons. 


###Data Visualization - Percent Green (Chlb/Chla)
####Percent Green -  Data table summary
The main thing to notice here compared to the other data is that our sample size is small (n=3 per trt combo)
```{r data table summary all treatments and nutrients pigments perc green, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
TxN.data.summary %>%
  select(treatment, temperature, mean_ug_cm2, sd_mass_ug_cm2, n) %>%
  filter(pigment_ID=="perc_green") %>%
  kable("html", digits=3, caption="Incubation experiment pigment data summary: means, standard deviation, and number of replicates per treatment") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = F, position="left", font_size=12)
```

####Percent Green - Descriptive statistics and plots
```{r histograms of each group perc_green, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
library(DescTools)
Desc(perc_green ~ temperature, data=TxN.data.trim.wide, digits=1, plotit=TRUE)
Desc(perc_green ~ treatment, data=TxN.data.trim.wide, digits=1, plotit=TRUE)

library(lattice)

histogram(~ perc_green | temperature, 
          data=TxN.data.trim.wide,
          layout=c(1,3),
          col="#3166A9",
          main="Chl B by Temperature")
histogram(~ perc_green | treatment, 
          data=TxN.data.trim.wide,
          layout=c(1,4),
          col="#3166A9",
          main="Chl B by Nutrient Treatment")
# Change stripchart colors by groups
ggplot(TxN.data.trim.wide, aes(x=temperature, y=perc_green, color=treatment)) +
   geom_boxplot(position=position_dodge(0.8))+
    geom_jitter(position=position_jitter(0.1))+
  scale_color_manual(values=c("#40A339", "#3166A9", "#DE0019", "#82388E"))+
  theme_classic2(base_size=16)

```

#### Chl B - ANOVA results - with intxn
```{r perc_green ANOVA Type III, echo=FALSE, tidy=TRUE}
PercGreen_Model1 <- lm(perc_green ~  temperature * treatment, data=TxN.data.trim.wide)
library(emmeans) #Estimated Marginal Means
emmip(PercGreen_Model1, temperature ~ treatment)
emmip(PercGreen_Model1, treatment~temperature)
Anova(PercGreen_Model1, type=3, contrasts=c("constr.sum","contr.poly"))

#First, it is necessary to set the contrasts option in R. Because the multi-way ANOVA model is over-parameterised
#it is necessary to choose a contrasts setting that sums to zero, otherwise the ANOVA analysis will give incorrect
#results with respect to the expected hypothesis. (The default contrasts type does not satisfy this requirement.)
#Doing a Type III test. This type tests for the presence of a main effect after the other main effect and interaction.
#This approach is therefore valid in the presence of significant interactions.
#http://goanna.cs.rmit.edu.au/~fscholer/anova.php 
```

Studying the output of the ANOVA table (Type III SS), <<womp womp>> nothing is significantly different.

```{r perc_Green qqplots and residuals, echo=FALSE, tidy=TRUE}
qqnorm(PercGreen_Model1$res)
plot(PercGreen_Model1$fitted,ChlA_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(perc_green ~  temperature * treatment, data=TxN.data.trim.wide)
```

Looks like we meet the assumptions of normality, but no need to move onto pairwise comparisons. 

###Data Visualization - Rare Benthic pigments (fuco, aphan)
```{r rare benthic pigments, echo=FALSE, tidy=TRUE}
TxN.data.rare.pigs <- TxN.raw %>%
  filter(!run_ID %in% c("6C", "7C", "8C","5C_rerun")) %>%
  filter(temperature %in% c("12","16"))%>%
  select(run_ID, temperature, sample_rep, treatment, pigment_ID, mass_ug_cm2) %>%
  filter(!pigment_ID %in% c("chla","chlb")) #I want to see which samples had fuco and myxo
#Long to wide
TxN.data.rare.pigs.wide <- dcast(TxN.data.rare.pigs, run_ID + temperature + treatment + sample_rep ~ pigment_ID, value.var="mass_ug_cm2") %>%
  arrange(temperature,treatment,run_ID)

#Visualize
stripchart(aphan ~ treatment, TxN.data.rare.pigs.wide, vertical=TRUE,
           method="jitter", pch=16, cex=4, col=SetAlpha(hred,0.4))
stripchart(fuco ~ treatment, TxN.data.rare.pigs.wide, vertical=TRUE,
           method="jitter", pch=16, cex=4, col=SetAlpha(hred,0.8))
```


## Correlations between Nutrients & Functional Responses

```{r combine nutrients and assays, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
incubation_merge <- incubation %>%
  select(treatment, temperature, sample_id, rep, NEP_ugcm2h, ER_ugcm2h, GPP_ugcm2h)
expchem_merge <- expchem_trim %>%
  select(treatment, temperature, sample_id, rep, changePO4_uM,  changeTDN_uM, changePO4_uM, changeDOC_mgL, changeNH4_mgL, percTDNuptake, percPO4uptake, chl_a_phyto, DOC_mgL, NH4_mgL)
incubation_corr <- left_join(incubation_merge, expchem_merge, by=c("treatment", "temperature", "sample_id", "rep"))

TxN.data.trim.wide <- TxN.data.trim.wide %>%
  rename(rep=sample_rep) %>%
  select(-run_ID)

incubation_corr <- left_join(incubation_corr, TxN.data.trim.wide, by=c("treatment", "temperature", "rep"))


incubation_corr_NAfree <- na.omit(incubation_corr)
glimpse(incubation_corr)
```

```{r correlations GPP and nutrients, echo=FALSE, tidy=TRUE, warning=FALSE, message=FALSE}
 library(GGally)
# pm <- ggpairs(incubation_corr, columns = c("GPP_ugcm2h","ER_ugcm2h","changePO4_uM","changeTDN_uM","changeNH4_mgL","chl_a_phyto"),
#                 lower = list(
#                 continuous = "smooth",
#                 combo = "facetdensity",
#                 color="treatment")) + theme_classic2(base_size=16) 
# pm
# library(corrplot)
# chlb  <- cor(incubation_corr_NAfree[,5:16])
# chlb
# corrplot(chlb, type = "upper", order = "hclust",
#          method=c("pie"),
#          tl.col = "black", tl.srt = 45,
#          title="Correlations between nutrient uptake and GPP/ER")


# chlb <- ggpairs(incubation_corr_NAfree, columns = c("chlb","GPP_ugcm2h","changePO4_uM","changeTDN_uM", "changeDOC_mgL"),
#                 lower = list(
#                 continuous = "smooth",
#                 combo = "facetdensity",
#                 color="treatment")) + theme_classic2(base_size=12) 
# chlb
# ggsave("benthicchlb_corrplot.png", width=9, height=9,units="in")

chla <- ggpairs(incubation_corr_NAfree, columns = c("chla","chlb","GPP_ugcm2h","ER_ugcm2h","changePO4_uM","changeTDN_uM","changeDOC_mgL","NH4_mgL"),
                lower = list(
                continuous = "smooth",
                combo = "facetdensity",
                color="treatment",
                xlab="Chl A correlations")) + theme_classic2(base_size=12) 
chla
# ggsave("benthicchla_corrplot.png", width=9, height=9,units="in")

perc_green <- ggpairs(incubation_corr_NAfree, columns = c("perc_green","GPP_ugcm2h","changePO4_uM","changeTDN_uM","changeDOC_mgL"),
                lower = list(
                continuous = "smooth",
                combo = "facetdensity",
                color="treatment",
                xlab="Chl A correlations")) + theme_classic2(base_size=12) 
perc_green
# ggsave("percgreen_corrplot.png", width=9, height=9,units="in")

phytochla <- ggpairs(incubation_corr, columns = c("GPP_ugcm2h","changePO4_uM","changeTDN_uM","chl_a_phyto"),
                lower = list(
                continuous = "smooth",
                combo = "facetdensity",
                color="treatment",
                xlab="Chl A correlations")) + theme_classic2(base_size=12) 
phytochla
# ggsave("phytochla_corrplot.png", width=9, height=9,units="in")

assay <- ggpairs(incubation_corr, columns = c("GPP_ugcm2h","ER_ugcm2h","changeDOC_mgL","changePO4_uM","changeTDN_uM","chl_a_phyto","DOC_mgL", "NH4_mgL"),
                lower = list(
                continuous = "smooth",
                combo = "facetdensity",
                color="treatment",
                xlab="Chl A correlations")) + theme_classic2(base_size=12)
assay
# ggsave("assay_corrplot.png", width=9, height=9,units="in")
```


####Subplots from correlation matrices
```{r more correlation plots, echo=FALSE, tidy=TRUE, warning=FALSE, message=FALSE}
chlb.GPP.corr=cor.test(incubation_corr_NAfree$GPP_ugcm2h,incubation_corr_NAfree$chlb, method="pearson")
chlb.GPP.corr$estimate
chlb.GPP.plot <- ggplot(incubation_corr_NAfree, aes(x=chlb, y=GPP_ugcm2h)) + geom_point(shape=1) +
       geom_smooth(method="lm", se= F, size = 1, aes(color = treatment,  group = treatment)) +
     geom_smooth(method = 'lm',size = 1, colour = 'black', se = F) + theme_bw() +
    ggtitle("Chl B vs GPP regression line") +
      labs(x="Benthic Chlorophyll B (ug/cm2)",
           y="GPP (ug O2/cm2/h)") +
      annotate("text", x=0.25, y=70, label = "R == 0.36", parse=T, size=8)+
    coord_cartesian(ylim=c(0,70))+    
  scale_y_continuous(breaks=seq(0, 70, 10))+
      theme_classic2(base_size=12)
chlb.GPP.plot

chlb.DOC.corr=cor.test(incubation_corr_NAfree$changeDOC_mgL,incubation_corr_NAfree$chlb, method="pearson")
chlb.DOC.corr$estimate
chlb.DOC.plot <- ggplot(incubation_corr_NAfree, aes(x=chlb, y=changeDOC_mgL)) +
  geom_point(shape=1) +
     geom_smooth(method="lm", se= F, size = 1, aes(color = treatment,  group = treatment)) +
     geom_smooth(method = 'lm',size = 1, colour = 'black', se = F) + theme_bw()+
  ggtitle("Chl B vs change in DOC regression line") +
      labs(x="Benthic Chlorophyll B (ug/cm2)",
           y="Change in DOC (mg/L)") +
      annotate("text", x=0.25, y=4, label = "R == -0.34", parse=T, size=8)+
    coord_cartesian(ylim=c(0,4))+
  scale_y_continuous(breaks=seq(0, 4, 1))+
      theme_classic2(base_size=12)
chlb.DOC.plot

chlb.NH4.corr=cor.test(incubation_corr_NAfree$NH4_mgL,incubation_corr_NAfree$chlb, method="pearson")
chlb.NH4.corr$estimate
chlb.NH4.plot <- ggplot(incubation_corr_NAfree, aes(x=chlb, y=NH4_mgL)) +
  geom_point(shape=1) +
     geom_smooth(method="lm", se= F, size = 1, aes(color = treatment,  group = treatment)) +
     geom_smooth(method = 'lm',size = 1, colour = 'black', se = F) + theme_bw()+
  ggtitle("Chl B vs NH4 regression line") +
      labs(x="Benthic Chlorophyll B (ug/cm2)",
           y="Conc of NH4 at end of exp (mg/L)") +
      annotate("text", x=0.25, y=0.5, label = chlb.NH4.corr$estimate, parse=T, size=8)+
    coord_cartesian(ylim=c(0,0.5))+
  scale_y_continuous(breaks=seq(0, 0.5, 0.1))+
      theme_classic2(base_size=12)
chlb.NH4.plot

chla.GPP.corr=cor.test(incubation_corr_NAfree$GPP_ugcm2h,incubation_corr_NAfree$chla, method="pearson")
chla.GPP.corr$estimate
chla.GPP.plot <- ggplot(incubation_corr_NAfree, aes(x=chlb, y=GPP_ugcm2h)) + geom_point(shape=1) +
     geom_smooth(method="lm", se= F, size = 1, aes(color = temperature,  group = temperature)) +
     geom_smooth(method = 'lm',size = 1, colour = 'black', se = F) + theme_bw()+
     ggtitle("Chl A vs GPP regression line") +
     labs(x="Benthic Chlorophyll A (ug/cm2)",
           y="GPP (ug O2/cm2/h)") +
     annotate("text", x=0.5, y=70, label = "R == 0.39 ", parse=T, size=8)+
     coord_cartesian(ylim=c(0,70))+    
     scale_y_continuous(breaks=seq(0, 70, 10))+
     theme_classic2(base_size=12)
chla.GPP.plot

chla.DOC.corr=cor.test(incubation_corr_NAfree$changeDOC_mgL,incubation_corr_NAfree$chla, method="pearson")
chla.DOC.corr$estimate
chla.DOC.plot <- ggplot(incubation_corr_NAfree, aes(x=chla, y=changeDOC_mgL)) + geom_point(shape=1) +
     geom_smooth(method="lm", se= F, size = 1, aes(color = treatment,  group = treatment)) +
     geom_smooth(method = 'lm',size = 1, colour = 'black', se = F) + theme_bw()+
  ggtitle("Chl A vs change in DOC regression line") +
      labs(x="Benthic Chlorophyll A (ug/cm2)",
           y="Change in DOC (mg/L)") +
      annotate("text", x=0.7, y=4, label = "R == -0.37", parse=T, size=8)+
    coord_cartesian(ylim=c(0,4))+    
  scale_y_continuous(breaks=seq(0, 4, 1))+
      theme_classic2(base_size=12)
chla.DOC.plot

chla.NH4.corr=cor.test(incubation_corr_NAfree$NH4_mgL,incubation_corr_NAfree$chla, method="pearson")
chla.NH4.corr$estimate
chla.NH4.plot <- ggplot(incubation_corr_NAfree, aes(x=chla, y=NH4_mgL)) +
  geom_point(shape=1) +
     geom_smooth(method="lm", se= F, size = 1, aes(color = temperature,  group = temperature)) +
     geom_smooth(method = 'lm',size = 1, colour = 'black', se = F) + theme_bw()+
  ggtitle("Chl A vs NH4 regression line") +
      labs(x="Benthic Chlorophyll A (ug/cm2)",
           y="Conc of NH4 at end of exp (mg/L)") +
      annotate("text", x=1, y=0.5, label = chla.NH4.corr$estimate, parse=T, size=8)+
    coord_cartesian(ylim=c(0,0.5))+
  scale_y_continuous(breaks=seq(0, 0.5, 0.1))+
      theme_classic2(base_size=12)
chla.NH4.plot


# percgreen.GPP.corr=cor.test(incubation_corr_NAfree$GPP_ugcm2h,incubation_corr_NAfree$perc_green, method="pearson")
# percgreen.GPP.corr$estimate
# percgreen.GPP.plot <- ggplot(incubation_corr_NAfree, aes(x=perc_green, y=GPP_ugcm2h)) + geom_point(shape=1) +
#       geom_smooth(method=lm, se=FALSE) + ggtitle("% Green vs GPP regression line") +
#       labs(x="Percent Green (Chlb/Chla)",
#            y="GPP (ug O2/cm2/h)") +
#       annotate("text", x=26, y=70, label = "R == -0.27 ", parse=T, size=8)+
#     coord_cartesian(ylim=c(0,70))+    
#   scale_y_continuous(breaks=seq(0, 70, 10))+
#       theme_classic2(base_size=12)
# percgreen.GPP.plot
# 
# percgreen.DOC.corr=cor.test(incubation_corr_NAfree$changeDOC_mgL,incubation_corr_NAfree$perc_green, method="pearson")
# percgreen.DOC.corr$estimate
# percgreen.DOC.plot <- ggplot(incubation_corr_NAfree, aes(x=perc_green, y=changeDOC_mgL)) + geom_point(shape=1) +
#       geom_smooth(method=lm, se=FALSE) + ggtitle("% Green vs change in DOC regression line") +
#       labs(x="Percent Green (Chlb/Chla)",
#            y="Change in DOC (mg/L)") +
#       annotate("text", x=25, y=-1, label = "R == 0.20 ", parse=T, size=8)+
#     coord_cartesian(ylim=c(0,-4))+    
#   scale_y_continuous(breaks=seq(0, -4, -1))+
#       theme_classic2(base_size=12)
# percgreen.DOC.plot
# 
# percgreen.TDN.corr=cor.test(incubation_corr_NAfree$changeTDN_uM,incubation_corr_NAfree$perc_green, method="pearson")
# percgreen.TDN.corr$estimate
# percgreen.TDN.plot <- ggplot(incubation_corr_NAfree, aes(x=perc_green, y=changeTDN_uM)) + geom_point(shape=1) +
#       geom_smooth(method=lm, se=FALSE) + ggtitle("% Green vs change in TDN regression line") +
#       labs(x="Percent Green (Chlb/Chla)",
#            y="Change in TDN (uM)") +
#       annotate("text", x=25, y=50, label = "R == 0.34 ", parse=T, size=8)+
#     coord_cartesian(ylim=c(0,60))+
#   scale_y_continuous(breaks=seq(0, 60, 10))+
#       theme_classic2(base_size=12)
# percgreen.TDN.plot

TDN.phytochla.corr=cor.test(incubation_corr$changeTDN_uM,incubation_corr$chl_a_phyto, method="pearson")
TDN.phytochla.corr$estimate
TDN.phytochla.plot <- ggplot(incubation_corr, aes(x=changeTDN_uM, y=chl_a_phyto)) + geom_point(shape=1) +
     geom_smooth(method="lm", se= F, size = 1, aes(color = temperature,  group = temperature)) +
     geom_smooth(method = 'lm',size = 1, colour = 'black', se = F) + theme_bw()+
      labs(x="Change in TDN",
           y="Phytoplankton Chl a") +
      annotate("text", x=10, y=70, label = "R == 0.83 ", parse=T, size=8)+
    coord_cartesian(ylim=c(0,70))+    
  scale_y_continuous(breaks=seq(0, 70, 10))+
      theme_classic2(base_size=12)
TDN.phytochla.plot

PO4.phytochla.corr=cor.test(incubation_corr$changePO4_uM,incubation_corr$chl_a_phyto, method="pearson")
PO4.phytochla.corr$estimate
PO4.phytochla.plot <- ggplot(incubation_corr, aes(x=changePO4_uM, y=chl_a_phyto)) + geom_point(shape=1) +
      geom_smooth(method="lm", se= F, size = 1, aes(color = treatment,  group = treatment)) +
     geom_smooth(method = 'lm',size = 1, colour = 'black', se = F) +
  ggtitle("PO4 uptake vs Phytoplankton Chl a") +
      labs(x="Change in PO4",
           y="Phytoplankton Chl a") +
      annotate("text", x=-10, y=70, label = "R == 0.26 ", parse=T, size=8)+
    coord_cartesian(ylim=c(0,70))+    
  scale_y_continuous(breaks=seq(0, 70, 10))+
      theme_classic2(base_size=12)
PO4.phytochla.plot

PO4.DOC.corr=cor.test(incubation_corr$changePO4_uM,incubation_corr$changeDOC_mgL, method="pearson")
PO4.DOC.corr$estimate
PO4.DOC.plot <- ggplot(incubation_corr, aes(x=changePO4_uM, y=changeDOC_mgL)) + geom_point(shape=1) +
      geom_smooth(method="lm", se= F, size = 1, aes(color = temperature,  group = temperature)) +
     geom_smooth(method = 'lm',size = 1, colour = 'black', se = F) +
  ggtitle("PO4 uptake vs DOC exudates") +
      labs(x="Change in PO4",
           y="Change in DOC") +
      annotate("text", x=-10, y=-1, label = "R == 0.62 ", parse=T, size=8)+
    # coord_cartesian(ylim=c(0,-4))+    
  # scale_y_continuous(breaks=seq(0, -4, -1))+
      theme_classic2(base_size=12)
PO4.DOC.plot

PO4.NH4.corr=cor.test(incubation_corr$changePO4_uM,incubation_corr$NH4_mgL, method="pearson")
PO4.NH4.corr$estimate
PO4.NH4.plot <- ggplot(incubation_corr, aes(x=changePO4_uM, y=NH4_mgL)) + geom_point(shape=1) +
      geom_smooth(method="lm", se= F, size = 1, aes(color = temperature,  group = temperature)) +
     geom_smooth(method = 'lm',size = 1, colour = 'black', se = F) +
  ggtitle("NH4 vs DOC exudates") +
      labs(x="Change in PO4",
           y="NH4 at end of exp (mg/L)") +
      annotate("text", x=-10, y=0.5, label = PO4.NH4.corr$estimate, parse=T, size=8)+
    # coord_cartesian(ylim=c(0,-4))+    
  # scale_y_continuous(breaks=seq(0, -4, -1))+
      theme_classic2(base_size=12)
PO4.NH4.plot




NH4.GPP.corr=cor.test(incubation_corr$NH4_mgL,incubation_corr$GPP_ugcm2h, method="pearson")
NH4.GPP.corr$estimate
NH4.GPP.plot <- ggplot(incubation_corr, aes(x=ER_ugcm2h, y=NH4_mgL)) + geom_point(shape=1) +
      geom_smooth(method=lm, se=FALSE) + ggtitle("NH4 conc vs GPP") +
      labs(x="GPP",
           y="NH4 conc at end of exp.") +
      annotate("text", x=30, y=1, label = "R == -0.32 ", parse=T, size=8)+
  # coord_cartesian(ylim=c(0,-4))+
  # scale_y_continuous(breaks=seq(0, -4, -1))+
      theme_classic2(base_size=12)
NH4.GPP.plot

NH4.ER.corr=cor.test(incubation_corr$NH4_mgL,incubation_corr$ER_ugcm2h, method="pearson")
NH4.ER.corr$estimate
NH4.ER.plot <- ggplot(incubation_corr, aes(x=ER_ugcm2h, y=NH4_mgL)) + geom_point(shape=1) +
      geom_smooth(method=lm, se=FALSE) + ggtitle("NH4 conc vs GPP") +
      labs(x="GPP",
           y="NH4 conc at end of exp.") +
      annotate("text", x=-45, y=1, label = "R == 0.25 ", parse=T, size=8)+
  # coord_cartesian(ylim=c(0,-4))+
  # scale_y_continuous(breaks=seq(0, -4, -1))+
      theme_classic2(base_size=12)
NH4.ER.plot


```

##Pelagic/Benthic Response Ratios

###Benthic Response Ratios first
```{r response ratios data wrangling, echo=FALSE, tidy=TRUE}
#Didn't get anywhere by looking at the response ratios of benthi chl a and benthic chl b

incubation_corr_NAfree <- incubation_corr_NAfree %>%
  mutate(BPratio=chla/chl_a_phyto)
library(DescTools)
Desc(BPratio ~ temperature, data=incubation_corr_NAfree, digits=1, plotit=TRUE)
Desc(BPratio ~ treatment, data=incubation_corr_NAfree, digits=1, plotit=TRUE)

trtcolors <- c("#38305c", "#9b3c73", "#ec5956", "#ffa600") #treatment colors
ggplot(incubation_corr_NAfree, aes(x=temperature, y=BPratio, fill=treatment)) +
  geom_boxplot()+
  stat_boxplot(geom ='errorbar') +
  scale_fill_manual(values=trtcolors,
                    name="",
                    labels=c("Control", "Nitrogen", "Phosphorus", "N&P"))+
  coord_cartesian(ylim=c(0,0.3))+
  scale_y_continuous(breaks=seq(0, 0.3, .05))+
  theme(axis.text.x = element_text(colour = "black", size = 20), axis.title.y=element_text(size=22, vjust=1.2, face="bold"),
        axis.text.y = element_text(colour = "black", size = 20), axis.title.x=element_text(size=22, vjust=-0.1, face="bold"),
        legend.text = element_text(colour="black", size = 20), legend.title=element_text(size=22, face="bold"),
        panel.border = element_rect(size=1.0, fill=NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank())+
  labs(x="Nutrient Treatment",y="Benthic:Pelagic Chla Ratio")
#Lower B:P means less benthic biomass relative to planktonic biomass
```

Lower B:P means less benthic biomass relative to planktonic biomass

```{r ANOVA B:P, echo=FALSE, tidy=TRUE}
BP_Model1 <- lm(BPratio ~  temperature * treatment, data=incubation_corr_NAfree)
library(emmeans) #Estimated Marginal Means
emmip(BP_Model1, temperature ~ treatment)
emmip(BP_Model1, treatment~temperature)
Anova(BP_Model1, type=3, contrasts=c("constr.sum","contr.poly"))

qqnorm(BP_Model1$res)
plot(BP_Model1$fitted,BP_Model1$res,xlab="Fitted",ylab="Residuals")
leveneTest(BPratio ~  temperature * treatment, data=incubation_corr_NAfree)
```


Pairwise comparsions for each level of temperature. Only at 16 degrees C do we see a difference between C & NP. 
```{r GPP pairwise trt x temp 2, echo=FALSE, tidy=TRUE}
library(emmeans) #Estimated Marginal Means
emms_BP_trtxtemp <- emmeans(BP_Model1, pairwise ~ treatment | temperature)
emms_BP_trtxtemp

emms_BP_tempxtrt <- emmeans(BP_Model1, pairwise ~ temperature | treatment)
emms_BP_tempxtrt
#Pairwise comparsions for each level of temperature
```


